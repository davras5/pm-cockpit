<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM Cockpit - Bundesamt für Bauten und Logistik</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* --- Design Tokens (Modern Unified Color Scheme) --- */
    :root {
      /* Primary Palette - Brand Colors */
      --primary-900: #383E54;
      --primary-700: #2D3748;
      --primary-500: #4A5568;
      --primary-100: #EDF2F7;

      /* Accent Palette - Unified Teal (Complete Scale) */
      --accent-700: #005F8A;
      --accent-600: #0077B6;
      --accent-500: #0096C7;
      --accent-400: #00B4D8;
      --accent-300: #48CAE4;
      --accent-200: #90E0EF;
      --accent-100: #CAF0F8;
      --accent-50: #E0F7FA;

      /* Neutral Palette - Enhanced Contrast Gray Scale
         Adjusted for better visibility of borders/dividers against white backgrounds */
      --neutral-900: #111827;
      --neutral-800: #1F2937;
      --neutral-700: #374151;
      --neutral-600: #4B5563;
      --neutral-500: #6B7280;
      --neutral-400: #8891A0;
      --neutral-300: #B0B8C4;
      --neutral-200: #D1D5DB;
      --neutral-100: #F1F5F9;
      --neutral-50: #FFFFFF;

      /* Priority Colors - Semantic Status Indicators
         Design Decision: Colors map to urgency/attention levels:
         - High (Red): Critical, requires immediate attention
         - Medium (Amber): Moderate priority, review soon
         - Standard (Green): Active/on-track, proceeding normally
         - Low (Blue): Informational, lower urgency
         - None (Gray): Inactive, archived, or no priority assigned
      */
      --priority-high: #DC2626;
      --priority-high-bg: #FEE2E2;
      --priority-high-text: #B91C1C;
      --priority-high-marker: #DC2626;

      /* Medium Priority - Amber (new tier for moderate urgency) */
      --priority-medium: #F59E0B;
      --priority-medium-bg: #FEF3C7;
      --priority-medium-text: #B45309;
      --priority-medium-marker: #F59E0B;

      /* Standard/Normal - Green indicates "on track" or "active" status */
      --priority-normal: #10B981;
      --priority-normal-bg: #D1FAE5;
      --priority-normal-text: #047857;
      --priority-normal-marker: #10B981;
      /* Semantic alias for clarity */
      --priority-standard: var(--priority-normal);
      --priority-standard-bg: var(--priority-normal-bg);
      --priority-standard-text: var(--priority-normal-text);

      --priority-low: #3B82F6;
      --priority-low-bg: #DBEAFE;
      --priority-low-text: #1D4ED8;
      --priority-low-marker: #3B82F6;

      --priority-none: #9CA3AF;
      --priority-none-bg: #F3F4F6;
      --priority-none-text: #6B7280;
      --priority-none-marker: #9CA3AF;

      --priority-null-bg: #F9FAFB;
      --priority-null-text: #9CA3AF;
      --priority-null-border: #E5E7EB;
      --priority-null-marker: #D1D5DB;

      /* Warning Colors - Caution/Attention States */
      --warning: #F59E0B;
      --warning-bg: #FEF3C7;
      --warning-text: #B45309;
      --warning-border: #FCD34D;

      /* Semantic Colors */
      --color-star: #FFC107;
      --color-star-empty: var(--neutral-300);

      /* Spacing Scale (4px base unit) */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-9: 36px;
      --space-10: 40px;
      --space-12: 48px;

      /* Semantic Spacing Aliases */
      --spacing-section: var(--space-8);      /* 32px - Major section separation */
      --spacing-subsection: var(--space-6);   /* 24px - Subsection separation */
      --spacing-element: var(--space-4);      /* 16px - Element spacing */
      --spacing-tight: var(--space-2);        /* 8px - Tight spacing */
      --spacing-micro: var(--space-1);        /* 4px - Micro spacing */

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
      --radius-full: 9999px;

      /* Typography Scale */
      --font-size-xs: 12px;
      --font-size-sm: 13px;
      --font-size-base: 14px;
      --font-size-md: 15px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 32px;

      /* Font Weights */
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;

      /* Line Heights */
      --line-height-tight: 1.25;
      --line-height-normal: 1.5;
      --line-height-relaxed: 1.625;

      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
      --transition-slow: 0.3s ease;

      /* Interactive States */
      --state-hover-bg: #F7FAFC;
      --state-active-bg: var(--accent-600);
      --state-focus-ring: 0 0 0 3px rgba(0, 119, 182, 0.2);
      --state-focus-ring-accent: 0 0 0 3px rgba(0, 150, 199, 0.3);
      --state-disabled: #CBD5E0;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.15);

      /* Overlays */
      --overlay-bg: rgba(0, 0, 0, 0.5);
    }

    /* --- Reset & Base --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--neutral-100); color: var(--neutral-900); line-height: var(--line-height-normal);
      display: flex; flex-direction: column; min-height: 100%;
    }

    /* --- Global Focus Styles (Accessibility) --- */
    :focus {
      outline: none;
    }
    :focus-visible {
      outline: 2px solid var(--accent-500);
      outline-offset: 2px;
    }
    /* Focus ring for buttons and interactive elements */
    button:focus-visible,
    [role="button"]:focus-visible,
    a:focus-visible {
      outline: 2px solid var(--accent-500);
      outline-offset: 2px;
    }
    /* Focus ring for form inputs */
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: none;
      border-color: var(--accent-600);
      box-shadow: var(--state-focus-ring);
    }
    /* Skip link for keyboard navigation */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent-600);
      color: var(--neutral-50);
      padding: var(--space-2) var(--space-4);
      z-index: 9999;
      transition: top var(--transition-normal);
    }
    .skip-link:focus {
      top: 0;
    }

    /* --- Header --- */
    .header {
      background-color: var(--primary-900); color: var(--neutral-50); padding: 0 var(--space-6);
      display: flex; align-items: center; justify-content: space-between;
      height: 64px; flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: var(--space-4); }
    .logo {
      width: 32px; height: 32px; color: var(--neutral-50);
      border-radius: 4px; display: flex; align-items: center; justify-content: center;
    }
    .logo .material-icons-outlined {
      font-size: 30px;
    }
    .header-title { display: flex; flex-direction: column; }
    .header-title-main { font-size: 14px; font-weight: 600; }
    .header-title-sub { font-size: 12px; opacity: 0.9; }
    .header-right { display: flex; gap: var(--space-4); }
    .btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      border: none;
      transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
    }
    .btn:focus-visible {
      outline: 2px solid var(--accent-300);
      outline-offset: 2px;
    }
    .btn-primary { background-color: var(--accent-600); color: var(--neutral-50); }
    .btn-primary:hover { background-color: var(--accent-500); }
    .btn-outline { background-color: transparent; color: var(--neutral-50); border: 1px solid var(--neutral-50); }
    .btn-outline:hover { background-color: rgba(255,255,255,0.1); }

    /* --- Search & Filter --- */
    .search-section { background: var(--neutral-50); padding: var(--space-4) 0; flex-shrink: 0; border-bottom: 1px solid var(--neutral-200); }
    .search-section-inner { max-width: 1440px; margin: 0 auto; padding: 0 var(--space-6); }
    .search-row { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4); }
    .search-input-wrapper { flex: 1; position: relative; }
    .search-input-wrapper .material-icons-outlined {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: var(--neutral-500); font-size: 20px;
    }
    .search-input {
      width: 100%; padding: var(--space-3) var(--space-4) var(--space-3) 44px;
      border: 1px solid var(--neutral-200); border-radius: 6px; font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus { outline: none; border-color: var(--accent-600); box-shadow: var(--state-focus-ring); }
    .view-toggle { display: flex; background: var(--neutral-100); border-radius: var(--radius-md); padding: var(--space-1); }
    .view-toggle .material-icons-outlined { font-size: 20px; }
    .view-btn {
      padding: var(--space-2) var(--space-3); border: none; background: transparent; cursor: pointer;
      border-radius: var(--radius-sm); color: var(--neutral-500); display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .view-btn:hover { color: var(--neutral-900); }
    .view-btn.active { background: var(--accent-600); color: var(--neutral-50); box-shadow: var(--shadow-sm); }
    .view-btn-label { font-size: 13px; font-weight: 500; margin-left: 6px; }

    /* --- Filter Row & Priority Pills --- */
    .filter-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--space-3); }
    .filter-pills { display: flex; flex-wrap: wrap; gap: var(--space-2); align-items: center; flex: 1; }
    .filter-pill {
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      background: var(--neutral-50);
      color: var(--neutral-700);
      cursor: pointer;
      transition: all var(--transition-normal);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .filter-pill:hover { border-color: var(--neutral-300); background: var(--neutral-100); }
    .filter-pill:focus-visible { outline: 2px solid var(--accent-500); outline-offset: 2px; }
    .filter-pill.active { background: var(--accent-600); border-color: var(--accent-600); color: var(--neutral-50); }
    .filter-pill .close-icon { display: none; font-size: 16px; margin-left: 2px; margin-right: -4px; }
    .filter-pill.active .close-icon { display: inline; }
    .reset-filters {
      display: none; align-items: center; justify-content: center; padding: var(--space-2);
      border: none; background: transparent; color: var(--neutral-500); cursor: pointer;
      border-radius: var(--radius-sm); transition: all var(--transition-normal);
    }
    .reset-filters.visible { display: flex; }
    .reset-filters:hover { background: var(--neutral-100); color: var(--neutral-900); }
    .filter-right { display: flex; align-items: center; gap: var(--space-4); }
    .stats-count { font-size: 14px; color: var(--neutral-700); font-weight: 600; }
    .filter-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-full);
      background: var(--neutral-50);
      font-size: var(--font-size-sm);
      color: var(--neutral-700);
      cursor: pointer;
      transition: all var(--transition-normal);
    }
    .filter-btn .material-icons-outlined { font-size: 20px; }
    .filter-btn:hover { border-color: var(--accent-600); color: var(--accent-600); }
    .filter-btn:focus-visible { outline: 2px solid var(--accent-500); outline-offset: 2px; }
    .filter-btn.has-filters { border-color: var(--accent-600); color: var(--accent-600); background: var(--accent-100); }
    .filter-btn.panel-open { border-color: var(--accent-600); color: var(--neutral-50); background: var(--accent-600); }
    .filter-btn .filter-count {
      background: var(--accent-600); color: var(--neutral-50); font-size: 11px; font-weight: 600;
      padding: 2px 6px; border-radius: 10px; margin-left: 2px;
    }

    /* --- Filter Modal --- */
    .filter-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg); display: flex; align-items: flex-start; justify-content: center;
      padding: 80px 20px 40px; z-index: 1000; overflow-y: auto;
      opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .filter-modal-overlay.active { opacity: 1; visibility: visible; }
    .filter-modal {
      background: var(--neutral-50); border-radius: 12px; width: 100%; max-width: 900px;
      box-shadow: var(--shadow-xl);
      transform: translateY(-20px); transition: transform 0.3s;
    }
    .filter-modal-overlay.active .filter-modal { transform: translateY(0); }
    .filter-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--space-5) var(--space-6); border-bottom: 1px solid var(--neutral-200);
    }
    .filter-modal-header h2 { font-size: 18px; font-weight: 600; color: var(--neutral-900); margin: 0; }
    .filter-modal-actions { display: flex; align-items: center; gap: var(--space-2); }
    .filter-reset-btn, .filter-close-btn {
      width: 36px; height: 36px; border: none; background: var(--neutral-100);
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--neutral-500);
    }
    .filter-reset-btn:hover, .filter-close-btn:hover { background: var(--neutral-200); color: var(--neutral-900); }
    .filter-modal-body { padding: var(--space-6); }
    .filter-columns { display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-6); }
    .filter-column-title { font-size: 14px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-4); }
    .filter-options { display: flex; flex-direction: column; gap: var(--space-2); }
    .filter-option {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      background: var(--neutral-100);
      color: var(--neutral-700);
      cursor: pointer;
      transition: all var(--transition-normal);
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .filter-option:hover { background: var(--state-hover-bg); border-color: var(--neutral-200); }
    .filter-option:focus-visible { outline: 2px solid var(--accent-500); outline-offset: 2px; }
    .filter-option.selected { background: var(--accent-600); color: var(--neutral-50); border-color: var(--accent-600); }
    .filter-option .close-icon { display: none; font-size: 16px; opacity: 0.7; }
    .filter-option.selected .close-icon { display: inline; }
    .filter-option.selected:hover .close-icon { opacity: 1; }

    @media (max-width: 900px) {
      .filter-columns { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 640px) {
      .filter-columns { grid-template-columns: repeat(2, 1fr); }
      .filter-modal { margin: 10px; max-width: calc(100% - 20px); }
    }

    /* --- Main Layout --- */
    .main {
      max-width: 1440px; margin: 0 auto; padding: var(--space-6);
      flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%;
    }

    /* --- Gallery Grid --- */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-6); }
    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

    /* --- Card Style --- */
    .card {
      background: var(--neutral-50); border-radius: 8px; overflow: hidden;
      box-shadow: var(--shadow-md); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .card-image { position: relative; height: 180px; background-color: var(--neutral-200); background-size: cover; background-position: center; }
    /* Tag Style Shared */
    .priority-tag { display: inline-block; padding: var(--space-1) var(--space-3); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; box-shadow: var(--shadow-sm); }
    .priority-0 { background-color: var(--priority-high-bg); color: var(--priority-high-text); }
    .priority-1 { background-color: var(--priority-normal-bg); color: var(--priority-normal-text); }
    .priority-2 { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
    .priority-3 { background-color: var(--priority-none-bg); color: var(--priority-none-text); }
    .priority-null { background-color: var(--priority-null-bg); color: var(--priority-null-text); border: 1px solid var(--priority-null-border); }

    /* Image Tags Container */
    .image-tags { position: absolute; top: var(--space-3); left: var(--space-3); display: flex; gap: var(--space-2); z-index: 2; }
    .year-tag { display: inline-block; padding: var(--space-1) var(--space-3); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; background-color: var(--priority-none-bg); color: var(--priority-none-text); box-shadow: var(--shadow-sm); }

    /* Clickable tag styles */
    .priority-tag[data-filter], .year-tag[data-filter] { cursor: pointer; transition: transform 0.15s, filter 0.15s; }
    .priority-tag[data-filter]:hover, .year-tag[data-filter]:hover { transform: scale(1.05); filter: brightness(0.95); }

    .card-badge { position: absolute; top: var(--space-3); left: var(--space-3); }
    .card-content { padding: var(--space-4); }
    .card-label { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .card-location { font-size: 13px; color: var(--neutral-700); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid var(--neutral-200); }
    .card-price { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .card-price-sqm { font-size: 12px; color: var(--neutral-500); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid var(--neutral-200); }
    .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2); font-size: 13px; margin-bottom: var(--space-4); }
    .card-detail-label { color: var(--neutral-700); font-weight: 500; }
    .card-detail-value { color: var(--neutral-900); font-weight: 500; }
    .card-milestone { padding-top: 0px; }
    .milestone-bar { height: 6px; background: var(--neutral-200); border-radius: 3px; overflow: hidden; margin-bottom: var(--space-2); }
    .milestone-progress { height: 100%; background: linear-gradient(90deg, var(--accent-600), var(--accent-500)); border-radius: 3px; transition: width 0.3s; }
    .milestone-text { font-size: 13px; color: var(--neutral-700); font-weight: 500; }

    /* --- List View --- */
    .view-container { display: none; }
    .view-container.active { display: block; }
    .stats-boxes { display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-4); margin-bottom: var(--space-6); }
    .stats-box { background: var(--neutral-50); border-radius: var(--radius-lg); padding: var(--space-5); text-align: center; box-shadow: var(--shadow-md); }
    .stats-box-value { font-size: 32px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .stats-box-label { font-size: 13px; color: var(--neutral-500); }
    .stats-box-download { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
    .stats-box-download:hover { background-color: var(--neutral-100); }
    .stats-box-download .material-icons-outlined { font-size: 32px; color: var(--neutral-500); margin-bottom: var(--space-1); }
    .list-table-container { background: var(--neutral-50); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); }
    .list-table { width: 100%; border-collapse: collapse; }
    .list-table th { background: var(--neutral-100); padding: var(--space-4); text-align: left; font-size: 13px; font-weight: 600; color: var(--neutral-700); border-bottom: 1px solid var(--neutral-200); }
    .list-table td { padding: var(--space-4); font-size: 14px; color: var(--neutral-900); border-bottom: 1px solid var(--neutral-200); vertical-align: middle; }
    .list-table tbody tr:hover { background-color: var(--neutral-100); cursor: pointer; }
    .object-cell { display: flex; align-items: center; gap: var(--space-3); }
    .object-icon { color: var(--neutral-500); font-size: 20px; }
    .milestone-text-small { font-size: 12px; color: var(--neutral-500); }

    /* --- MAP VIEW & SIDEBAR FIXES --- */
    .map-container {
        display: none; width: 100%;
        flex: 1; min-height: 0;
        background: var(--neutral-50); border-radius: 8px; overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    .map-container.active { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 1fr; max-height: 1200px; }

    .map-sidebar {
        width: 100%; height: 100%;
        background: var(--neutral-50); overflow-y: auto;
        border-right: 1px solid var(--neutral-200);
        scrollbar-width: thin;
    }

    /* Sidebar Item Fixes */
    .map-sidebar-item {
        padding: var(--space-4);
        border-bottom: 1px solid var(--neutral-200);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column; /* Stack: Image top, Text bottom */
        gap: var(--space-3);
    }
    .map-sidebar-item:hover { background-color: var(--neutral-100); }
    .map-sidebar-item.active { background-color: var(--accent-100); padding-left: var(--space-3); border-left: 3px solid var(--accent-600); } /* Highlight style */

    .map-sidebar-image {
        position: relative;
        width: 100%;
        height: 160px; /* Fixed Height für Bild */
        background-color: var(--neutral-200);
        background-size: cover;
        background-position: center;
        border-radius: 6px;
        overflow: hidden;
    }
    /* Tags im Bild oben links */
    .map-sidebar-image .image-tags {
        top: 10px;
        left: 10px;
    }

    .map-sidebar-content { display: flex; flex-direction: column; gap: var(--space-1); }
    .map-sidebar-title { font-size: 15px; font-weight: 600; color: var(--neutral-900); line-height: 1.3; }
    .map-sidebar-price { font-size: 14px; font-weight: 600; color: var(--accent-600); margin-top: var(--space-1); }

    .map-area { position: relative; width: 100%; height: 100%; background-color: var(--neutral-200); overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }

    /* Map Markers */
    .marker {
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid var(--neutral-50);
        /* Enhanced shadow for visibility on satellite/terrain maps */
        box-shadow:
          0 2px 6px rgba(0,0,0,0.4),
          0 0 0 1px rgba(255,255,255,0.3),
          0 4px 12px rgba(0,0,0,0.25);
    }
    .marker-0 { background-color: var(--priority-high-marker); }
    .marker-1 { background-color: var(--priority-normal-marker); }
    .marker-2 { background-color: var(--priority-low-marker); }
    .marker-3 { background-color: var(--priority-none-marker); }
    .marker-null { background-color: var(--priority-null-marker); }
    .marker .material-icons-outlined { color: var(--neutral-50); font-size: 16px; }
    .marker.selected {
        border: 3px solid var(--accent-600);
        transform: scale(1.15);
        z-index: 10;
        box-shadow:
          0 2px 6px rgba(0,0,0,0.4),
          0 0 0 2px rgba(0, 119, 182, 0.5),
          0 4px 16px rgba(0,0,0,0.3);
    }

    .mapboxgl-popup-content { padding: 0; border-radius: 8px; overflow: hidden; min-width: 250px; }
    .popup-image { height: 120px; background-size: cover; background-position: center; }
    .popup-content { padding: var(--space-3); }
    .popup-title { font-weight: 600; margin-bottom: var(--space-1); }
    .popup-link { display: block; text-align: center; padding: var(--space-2) var(--space-3); background: var(--primary-900); color: var(--neutral-50); text-decoration: none; border-radius: var(--radius-sm); margin-top: var(--space-2); cursor: pointer; }

    /* Responsive */
    @media (max-width: 900px) { .stats-boxes { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) {
        .map-container.active { display: flex; flex-direction: column; height: auto; }
        .map-sidebar { width: 100%; max-height: 250px; border-right: none; border-bottom: 1px solid var(--neutral-200); }
        .map-area { height: 400px; width: 100%; }
        .map-sidebar-image { height: 120px; } /* Kleineres Bild auf Mobile */
    }
    @media (max-width: 640px) {
        .header { padding: 12px 16px; height: auto; flex-wrap: wrap; gap: 12px; }
        .search-row, .filter-row { flex-direction: column; align-items: stretch; }
        .grid { grid-template-columns: 1fr; }
    }

    /* --- Footer --- */
    .footer {
      background-color: var(--primary-900);
      color: var(--neutral-50);
      padding: var(--space-1) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: left;
      gap: var(--space-8);
      flex-shrink: 0;
    }
    .footer-link {
      color: var(--neutral-50);
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.2s;
    }
    .footer-link:hover {
      opacity: 0.8;
    }

    /* --- Image Carousel --- */
    .carousel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .carousel-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .carousel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      color: var(--neutral-50);
    }
    .carousel-counter {
      font-size: 14px;
      font-weight: 500;
    }
    .carousel-close-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      transition: background 0.2s;
    }
    .carousel-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .carousel-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0;
      padding: 0 80px;
    }
    .carousel-image-container {
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel-image {
      max-width: 100%;
      max-height: calc(100vh - 200px);
      object-fit: contain;
      border-radius: 4px;
    }
    .carousel-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      transition: background 0.2s;
      z-index: 10;
    }
    .carousel-nav-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .carousel-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .carousel-nav-btn.prev {
      left: 16px;
    }
    .carousel-nav-btn.next {
      right: 16px;
    }
    .carousel-thumbnails {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 16px 24px 24px;
      overflow-x: auto;
    }
    .carousel-thumb {
      width: 64px;
      height: 48px;
      border-radius: 4px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s, box-shadow 0.2s;
      flex-shrink: 0;
      border: 2px solid transparent;
    }
    .carousel-thumb:hover {
      opacity: 0.8;
    }
    .carousel-thumb.active {
      opacity: 1;
      border-color: var(--accent-500);
      box-shadow: 0 0 0 2px rgba(0, 150, 199, 0.3);
    }

    /* Clickable gallery images - zoom effect via pseudo-element */
    .detail-main-image.clickable,
    .detail-thumb.clickable {
      cursor: pointer;
      overflow: hidden;
    }
    .detail-main-image.clickable::before,
    .detail-thumb.clickable::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: inherit;
      border-radius: inherit;
      z-index: 1;
      transition: transform 0.3s ease;
    }
    .detail-main-image.clickable:hover::before,
    .detail-thumb.clickable:hover::before {
      transform: scale(1.05);
    }

    /* Carousel responsive */
    @media (max-width: 768px) {
      .carousel-main {
        padding: 0 16px;
      }
      .carousel-nav-btn {
        width: 40px;
        height: 40px;
      }
      .carousel-nav-btn.prev {
        left: 8px;
      }
      .carousel-nav-btn.next {
        right: 8px;
      }
      .carousel-thumb {
        width: 48px;
        height: 36px;
      }
    }

    /* --- Tab Content Visibility --- */
    .tab-content-uebersicht,
    .tab-content-dokumente {
      display: none;
    }
    .tab-content-uebersicht.active,
    .tab-content-dokumente.active {
      display: block;
    }

    /* --- Shared Tab Container Styles --- */
    .tab-container { padding: 0; }
    .tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 16px 0;
    }
    .tab-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .tab-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 16px 0;
      gap: 16px;
    }
    .tab-search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      padding: 8px 12px;
      min-width: 240px;
    }
    .tab-search .material-icons-outlined {
      color: var(--neutral-400);
      font-size: 20px;
    }
    .tab-search input {
      border: none;
      outline: none;
      font-size: 14px;
      color: var(--neutral-700);
      background: transparent;
      width: 100%;
    }
    .tab-search input::placeholder { color: var(--neutral-400); }
    .tab-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* --- Shared Table Action Button Styles --- */
    .table-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--neutral-400);
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: not-allowed;
      transition: all 0.2s;
    }
    .table-action-btn .material-icons-outlined { font-size: 18px; }
    .table-action-btn.active {
      color: var(--neutral-600);
      cursor: pointer;
    }
    .table-action-btn.active:hover {
      background: var(--neutral-100);
      color: var(--neutral-900);
    }
    .table-btn-outline {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--neutral-300);
      background: transparent;
      color: var(--neutral-700);
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .table-btn-outline:hover {
      background: var(--neutral-100);
      border-color: var(--neutral-400);
    }
    .table-btn-outline .material-icons-outlined { font-size: 18px; }

    /* --- Shared Data Table Styles --- */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th,
    .data-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--neutral-200);
    }
    .data-table th {
      font-size: 13px;
      font-weight: 600;
      color: var(--neutral-700);
      background: var(--neutral-100);
      white-space: nowrap;
    }
    .data-table td {
      font-size: 14px;
      color: var(--neutral-900);
    }
    .data-table tbody tr:hover td { background: var(--neutral-100); }
    .data-table tbody tr.selected td { background: var(--accent-50); }
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
    }
    .data-table th.sortable:hover { color: var(--neutral-900); }
    .data-table th .sort-icon {
      font-size: 16px;
      vertical-align: middle;
      margin-left: 2px;
      opacity: 0.5;
    }
    .data-table th.sortable:hover .sort-icon { opacity: 1; }
    .data-table-checkbox { width: 48px; }
    .data-table-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-600);
    }

    /* --- Shared Empty State --- */
    .tab-empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--neutral-500);
    }
    .tab-empty .material-icons-outlined {
      font-size: 48px;
      color: var(--neutral-300);
      margin-bottom: 16px;
    }

    /* --- Documents Tab Specific --- */
    .doc-title a {
      color: var(--neutral-900);
      text-decoration: none;
      transition: color 0.2s;
    }
    .doc-title a:hover {
      color: var(--accent-600);
      text-decoration: underline;
    }

    /* --- Events Tab Specific --- */
    .tab-content-ereignisse { display: none; }
    .tab-content-ereignisse.active { display: block; }

    /* --- Meilensteine Tab Specific --- */
    .tab-content-meilensteine { display: none; }
    .tab-content-meilensteine.active { display: block; }

    .milestone-list {
      display: flex;
      flex-direction: column;
    }

    .milestone-item {
      display: flex;
      align-items: flex-start;
      padding: var(--space-6) 0;
      border-bottom: 1px solid var(--neutral-200);
    }

    .milestone-item:last-child {
      border-bottom: none;
    }

    .milestone-content {
      flex: 1;
      min-width: 0;
    }

    .milestone-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: var(--space-2);
    }

    .milestone-status {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
    }

    .milestone-status-icon {
      font-size: 20px;
    }

    .milestone-status-icon.completed {
      color: var(--priority-normal);
    }

    .milestone-status-icon.pending {
      color: var(--neutral-300);
    }

    .milestone-status-text {
      font-size: 14px;
      color: var(--neutral-600);
    }

    .milestone-responsibility {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--neutral-600);
      background: var(--neutral-50);
    }

    .milestone-action {
      flex-shrink: 0;
      margin-left: var(--space-6);
    }

    .milestone-btn {
      padding: var(--space-2) var(--space-5);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .milestone-btn-complete {
      background: var(--accent-600);
      color: var(--neutral-50);
      border: 1px solid var(--accent-600);
    }

    .milestone-btn-complete:hover {
      background: var(--accent-500);
      border-color: var(--accent-500);
    }

    .milestone-btn-completed {
      background: var(--neutral-50);
      color: var(--neutral-500);
      border: 1px solid var(--neutral-300);
      cursor: default;
    }

    .milestone-btn-pending {
      background: var(--neutral-100);
      color: var(--neutral-400);
      border: 1px solid var(--neutral-200);
      cursor: not-allowed;
    }

    /* --- Upload Dialog Overlay --- */
    .upload-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .upload-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .upload-dialog {
      background: var(--neutral-50);
      border-radius: 12px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .upload-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--neutral-200);
    }
    .upload-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .upload-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--neutral-500);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .upload-dialog-close:hover {
      background: var(--neutral-100);
    }
    .upload-step {
      padding: 16px 24px;
    }
    .upload-step:first-of-type {
      padding-top: 24px;
    }
    .upload-step-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: 8px;
    }
    .upload-dropzone {
      border: 2px dashed var(--neutral-300);
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-dropzone:hover {
      border-color: var(--accent-600);
      background: var(--accent-100);
    }
    .upload-dropzone.dragover {
      border-color: var(--accent-600);
      background: var(--accent-100);
    }
    .upload-dropzone.has-file {
      border-color: var(--accent-600);
      border-style: solid;
      background: var(--accent-100);
    }
    .upload-dropzone-text {
      color: var(--neutral-500);
      font-size: 14px;
    }
    .upload-dropzone-filename {
      color: var(--accent-600);
      font-weight: 500;
    }
    .upload-select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      cursor: pointer;
    }
    .upload-select:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .upload-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      box-sizing: border-box;
    }
    .upload-input:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .upload-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 20px 24px;
      border-top: 1px solid var(--neutral-200);
    }
    .upload-btn-cancel {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .upload-btn-cancel:hover {
      background: var(--neutral-100);
    }
    .upload-btn-submit {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: var(--accent-600);
      color: var(--neutral-50);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .upload-btn-submit:hover:not(:disabled) {
      background: var(--accent-500);
    }
    .upload-btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- Login Dialog Styles --- */
    .login-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .login-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .login-dialog {
      background: var(--neutral-50);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .login-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--neutral-200);
    }
    .login-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .login-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--neutral-500);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .login-dialog-close:hover {
      background: var(--neutral-100);
    }
    .login-form {
      padding: var(--space-6);
    }
    .login-field {
      margin-bottom: var(--space-4);
    }
    .login-field:last-of-type {
      margin-bottom: 0;
    }
    .login-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: var(--space-2);
    }
    .login-input {
      width: 100%;
      padding: var(--space-3);
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-md);
      background: var(--neutral-50);
      color: var(--neutral-700);
      box-sizing: border-box;
    }
    .login-input:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .login-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      padding: var(--space-5) var(--space-6);
      border-top: 1px solid var(--neutral-200);
    }
    .login-btn-cancel {
      padding: var(--space-3) var(--space-5);
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-btn-cancel:hover {
      background: var(--neutral-100);
    }
    .login-btn-submit {
      padding: var(--space-3) var(--space-5);
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: var(--accent-600);
      color: var(--neutral-50);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-btn-submit:hover {
      background: var(--accent-500);
    }
    .login-links {
      display: flex;
      justify-content: space-between;
      padding: 0 var(--space-6) var(--space-4);
    }
    .login-link {
      font-size: 13px;
      color: var(--accent-600);
      text-decoration: none;
      cursor: pointer;
    }
    .login-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Zum Hauptinhalt springen</a>
  <header class="header">
    <div class="header-left">
      <div class="logo"><span class="material-icons-outlined">replay</span></div>
      <div class="header-title">
        <span class="header-title-main">PM Cockpit</span>
        <span class="header-title-sub">Bundesamt für Bauten und Logistik</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-outline" onclick="openLoginDialog()">Login</button>
    </div>
  </header>

  <div class="search-section">
    <div class="search-section-inner">
      <div class="search-row">
        <div class="search-input-wrapper">
          <span class="material-icons-outlined">search</span>
          <input type="text" class="search-input" id="searchInput" placeholder="Suche nach Bezeichnung, Adresse, oder Wirtschaftseinheit">
        </div>
        <div class="view-toggle">
          <button class="view-btn" data-view="map" title="Karte"><span class="material-icons-outlined">map</span></button>
          <button class="view-btn" data-view="list" title="Liste"><span class="material-icons-outlined">reorder</span><span class="view-btn-label">Liste</span></button>
          <button class="view-btn active" data-view="gallery" title="Galerie"><span class="material-icons-outlined">grid_view</span></button>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-pills" id="filterPills"></div>
        <div class="filter-right">
          <div class="stats-count"><span id="objectCount">0</span> Objekte</div>
          <button class="filter-btn" id="filterBtn">
            <span>Filter</span>
            <span class="filter-count" id="filterCount" style="display: none;">0</span>
            <span class="material-icons-outlined">tune</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="main" id="main">
    <div class="view-container active" id="galleryView">
      <div class="grid" id="objectGrid"></div>
    </div>

    <div class="view-container" id="listView">
      <div class="stats-boxes" id="statsBoxes">
        <div class="stats-box"><div class="stats-box-value" id="statsTotalObjects">0</div><div class="stats-box-label">Anzahl Objekte</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsHighPriority">0</div><div class="stats-box-label">Hohe Priorität</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsNormalPriority">0</div><div class="stats-box-label">Normale Priorität</div></div>
        <div class="stats-box"><div class="stats-box-value" id="statsLowPriority">0</div><div class="stats-box-label">Geringe Priorität</div></div>
        <div class="stats-box stats-box-download" onclick="exportToExcel()"><span class="material-icons-outlined">download</span><div class="stats-box-label">Excel Download</div></div>
      </div>
      <div class="list-table-container">
        <table class="list-table">
          <thead><tr><th></th><th>ID</th><th>Objekt</th><th>Verkaufsjahr</th><th>Priorisierung</th><th>Meilenstein</th><th>Objekt Fläche</th><th>Marktwert</th></tr></thead>
          <tbody id="listTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="map-container" id="mapView">
      <div class="map-sidebar" id="mapSidebar"></div>
      <div class="map-area">
        <div id="map"></div>
      </div>
    </div>
  </main>

  <!-- Filter Modal -->
  <div class="filter-modal-overlay" id="filterModalOverlay" role="dialog" aria-modal="true" aria-labelledby="filterModalTitle">
    <div class="filter-modal">
      <div class="filter-modal-header">
        <h2 id="filterModalTitle">Suchfilter</h2>
        <div class="filter-modal-actions">
          <button class="filter-reset-btn" id="filterResetBtn" title="Filter zurücksetzen">
            <span class="material-icons-outlined">refresh</span>
          </button>
          <button class="filter-close-btn" id="filterCloseBtn">
            <span class="material-icons-outlined">close</span>
          </button>
        </div>
      </div>
      <div class="filter-modal-body">
        <div class="filter-columns">
          <div class="filter-column">
            <h3 class="filter-column-title">Nutzung</h3>
            <div class="filter-options" id="filterNutzung"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Verkaufsjahr</h3>
            <div class="filter-options" id="filterYear"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Priorisierung</h3>
            <div class="filter-options" id="filterPriority"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Meilenstein</h3>
            <div class="filter-options" id="filterMilestone"></div>
          </div>
          <div class="filter-column">
            <h3 class="filter-column-title">Portfolio</h3>
            <div class="filter-options" id="filterPortfolio"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Carousel -->
  <div class="carousel-overlay" id="carouselOverlay" role="dialog" aria-modal="true" aria-label="Bildergalerie">
    <div class="carousel-header">
      <span class="carousel-counter" id="carouselCounter" aria-live="polite">1 / 5</span>
      <button class="carousel-close-btn" onclick="closeCarousel()" title="Schliessen (Esc)">
        <span class="material-icons-outlined">close</span>
      </button>
    </div>
    <div class="carousel-main" onclick="if(event.target === this) closeCarousel()">
      <button class="carousel-nav-btn prev" onclick="navigateCarousel(-1)" title="Vorheriges Bild">
        <span class="material-icons-outlined">chevron_left</span>
      </button>
      <div class="carousel-image-container">
        <img class="carousel-image" id="carouselImage" src="" alt="Bild">
      </div>
      <button class="carousel-nav-btn next" onclick="navigateCarousel(1)" title="Nächstes Bild">
        <span class="material-icons-outlined">chevron_right</span>
      </button>
    </div>
    <div class="carousel-thumbnails" id="carouselThumbnails"></div>
  </div>

  <!-- Login Dialog -->
  <div class="login-dialog-overlay" id="loginDialogOverlay" role="dialog" aria-modal="true" aria-labelledby="loginDialogTitle" onclick="if(event.target === this) closeLoginDialog()">
    <div class="login-dialog">
      <div class="login-dialog-header">
        <h3 class="login-dialog-title" id="loginDialogTitle">Anmelden</h3>
        <button class="login-dialog-close" onclick="closeLoginDialog()" aria-label="Schliessen">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>

      <div class="login-form">
        <div class="login-field">
          <label class="login-label" for="loginEmail">E-Mail</label>
          <input type="email" class="login-input" id="loginEmail" placeholder="name@beispiel.ch">
        </div>

        <div class="login-field">
          <label class="login-label" for="loginPassword">Passwort</label>
          <input type="password" class="login-input" id="loginPassword" placeholder="Passwort eingeben">
        </div>
      </div>

      <div class="login-links">
        <a class="login-link" onclick="alert('Funktion noch nicht verfügbar')">Kennwort vergessen?</a>
        <a class="login-link" onclick="alert('Funktion noch nicht verfügbar')">Neu registrieren</a>
      </div>

      <div class="login-actions">
        <button class="login-btn-cancel" onclick="closeLoginDialog()">Abbrechen</button>
        <button class="login-btn-submit" onclick="submitLogin()">Anmelden</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/davras5/pm-cockpit" class="footer-link" target="_blank" rel="noopener noreferrer">Quellcode</a>
    <a href="https://www.admin.ch/gov/de/start/rechtliches.html" class="footer-link" target="_blank" rel="noopener noreferrer">Rechtliches</a>
  </footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';

    let properties = [];
    let filteredProperties = [];
    let searchQuery = '';
    let currentView = 'gallery';
    let map = null;
    let mapLoaded = false;
    let markers = [];
    let markersMap = new Map();

    // Advanced filter state
    let advancedFilters = {
      type: new Set(),        // Nutzung
      year: new Set(),        // Verkaufsjahr
      priority: new Set(),    // Priorisierung
      milestone: new Set(),   // Meilenstein
      portfolio: new Set()    // Portfolio
    };

    // Unique values from data (populated after load)
    let filterOptions = {
      type: [],
      year: [],
      priority: [],
      milestone: [],
      portfolio: []
    };

    // Carousel state
    let carouselImages = [];
    let carouselIndex = 0;

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        view: params.get('view'),
        id: params.get('id'),
        q: params.get('q'),
        type: params.get('type'),
        year: params.get('year'),
        priority: params.get('priority'),
        milestone: params.get('milestone'),
        portfolio: params.get('portfolio')
      };
    }

    function updateUrlParams() {
      const params = new URLSearchParams();
      if (currentView !== 'gallery') params.set('view', currentView);
      if (searchQuery) params.set('q', searchQuery);

      // Add all advanced filters
      Object.keys(advancedFilters).forEach(key => {
        if (advancedFilters[key].size > 0) {
          params.set(key, Array.from(advancedFilters[key]).join(','));
        }
      });

      const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function loadFiltersFromUrl() {
      const params = getUrlParams();
      if (params.view && ['gallery', 'list', 'map'].includes(params.view)) currentView = params.view;
      if (params.q) {
        searchQuery = params.q;
        document.getElementById('searchInput').value = searchQuery;
      }

      // Load all advanced filters from URL
      ['type', 'year', 'priority', 'milestone', 'portfolio'].forEach(key => {
        if (params[key]) {
          params[key].split(',').forEach(val => advancedFilters[key].add(val));
        }
      });
    }

    function getPriorityClass(priority) { return (priority === null || priority === undefined) ? 'priority-null' : `priority-${priority}`; }
    function getPriorityLabel(priority, priorityLabel) { return (priority === null || priority === undefined) ? 'Keine Angabe' : priorityLabel; }
    function getPriorityValue(priority) { return (priority === null || priority === undefined) ? 'null' : String(priority); }
    function formatCHF(value) { return (!value) ? 'CHF 0' : 'CHF ' + value.toLocaleString('de-CH').replace(/,/g, "'"); }
    function formatNumber(value) { return (!value && value !== 0) ? '0' : value.toLocaleString('de-CH').replace(/,/g, "'"); }
    function formatPriceRange(min, max) { return ((!min) && (!max)) ? 'CHF 0 - CHF 0' : formatCHF(min) + ' - ' + formatCHF(max); }
    function pricePerSqm(price, area) { return (!price || !area) ? 0 : Math.round(price / area); }
    function formatCoord(value, dir) {
      if (!value) return '-';
      const abs = Math.abs(value);
      const deg = Math.floor(abs);
      const minFloat = (abs - deg) * 60;
      const min = Math.floor(minFloat);
      const sec = ((minFloat - min) * 60).toFixed(1);
      return `${deg}°${min}'${sec}"${dir}`;
    }

    function getPlaceholderImage(type, id) {
      const idStr = String(id);
      const hash = idStr.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imageIndex = Math.abs(hash) % 5;
      const images = ['https://images.unsplash.com/photo-1568605114967-8130f3a36994', 'https://images.unsplash.com/photo-1570129477492-45c003edd2be', 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6', 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab', 'https://images.unsplash.com/photo-1581094794329-c8112a89af12'];
      return images[imageIndex] + '?w=400&h=300&fit=crop';
    }

    // Extract unique filter options from data
    function extractFilterOptions() {
      const types = new Set();
      const years = new Set();
      const priorities = new Map(); // value -> label
      const milestones = new Map(); // current/total -> label
      const portfolios = new Set();

      properties.forEach(prop => {
        if (prop.type) types.add(prop.type);
        if (prop.year) years.add(prop.year);

        const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
        const pLabel = getPriorityLabel(prop.priority, prop.priorityLabel);
        priorities.set(pKey, pLabel);

        if (prop.milestone) {
          const mKey = `${prop.milestone.current}/${prop.milestone.total}`;
          milestones.set(mKey, prop.milestone.label);
        }

        if (prop.portfolio) portfolios.add(prop.portfolio);
      });

      filterOptions.type = Array.from(types).sort();
      filterOptions.year = Array.from(years).sort((a, b) => a - b);
      filterOptions.priority = Array.from(priorities.entries()).map(([value, label]) => ({ value, label }));
      filterOptions.milestone = Array.from(milestones.entries()).map(([value, label]) => ({ value, label }));
      filterOptions.portfolio = Array.from(portfolios).sort();
    }

    // Check if any filters are active
    function hasActiveFilters() {
      return Object.values(advancedFilters).some(set => set.size > 0) || searchQuery;
    }

    // Count total active filters (excluding search)
    function getActiveFilterCount() {
      let count = 0;
      Object.values(advancedFilters).forEach(set => count += set.size);
      return count;
    }

    // Get priority counts from all properties
    function getPriorityCounts() {
      const counts = { '0': 0, '1': 0, '2': 0, '3': 0, 'null': 0 };
      properties.forEach(prop => {
        const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
        if (counts.hasOwnProperty(pKey)) counts[pKey]++;
      });
      return counts;
    }

    // Update the filter button appearance and count
    function updateFilterButtonState() {
      const btn = document.getElementById('filterBtn');
      const countEl = document.getElementById('filterCount');
      const count = getActiveFilterCount();

      if (count > 0) {
        btn.classList.add('has-filters');
        countEl.textContent = count;
        countEl.style.display = 'inline';
      } else {
        btn.classList.remove('has-filters');
        countEl.style.display = 'none';
      }
    }

    // Render priority pills and reset button
    function renderPriorityPills() {
      const container = document.getElementById('filterPills');
      const counts = getPriorityCounts();

      // Priority labels mapping
      const priorityLabels = {
        '0': 'Hohe Priorität',
        '1': 'Normale Priorität',
        '2': 'Geringe Priorität',
        '3': 'Keine Priorität',
        'null': 'Keine Angabe'
      };

      // Build pills HTML
      let html = ['0', '1', '2', '3', 'null'].map(pKey => {
        const isActive = advancedFilters.priority.has(pKey);
        return `
          <button class="filter-pill ${isActive ? 'active' : ''}" data-priority="${pKey}">
            ${priorityLabels[pKey]} (${counts[pKey]})
            <span class="material-icons-outlined close-icon">close</span>
          </button>
        `;
      }).join('');

      // Add reset button
      html += `
        <button class="reset-filters ${hasActiveFilters() ? 'visible' : ''}" id="resetFilters" title="Alle Filter zurücksetzen">
          <span class="material-icons-outlined">replay</span>
        </button>
      `;

      container.innerHTML = html;

      // Add click handlers for priority pills
      container.querySelectorAll('.filter-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const priority = pill.dataset.priority;
          if (advancedFilters.priority.has(priority)) {
            advancedFilters.priority.delete(priority);
          } else {
            advancedFilters.priority.add(priority);
          }
          applyFilters();
          renderFilterModal();
        });
      });

      // Add click handler for reset button
      const resetBtn = container.querySelector('#resetFilters');
      if (resetBtn) {
        resetBtn.addEventListener('click', resetAllFilters);
      }
    }

    // Reset all filters
    function resetAllFilters() {
      Object.keys(advancedFilters).forEach(key => advancedFilters[key].clear());
      searchQuery = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
      if (document.getElementById('filterModalOverlay').classList.contains('active')) {
        renderFilterModal();
      }
    }

    // Apply all filters
    function applyFilters() {
      filteredProperties = properties.filter(prop => {
        // Search query filter
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          const searchFields = [prop.econUnit, prop.bldgNum, prop.title, prop.type, prop.city, prop.zip, prop.address, prop.canton].map(f => (f || '').toString().toLowerCase());
          if (!searchFields.some(field => field.includes(query))) return false;
        }

        // Type filter (OR within category)
        if (advancedFilters.type.size > 0 && !advancedFilters.type.has(prop.type)) {
          return false;
        }

        // Year filter (OR within category)
        if (advancedFilters.year.size > 0 && !advancedFilters.year.has(String(prop.year))) {
          return false;
        }

        // Priority filter (OR within category)
        if (advancedFilters.priority.size > 0) {
          const pKey = prop.priority !== null && prop.priority !== undefined ? String(prop.priority) : 'null';
          if (!advancedFilters.priority.has(pKey)) return false;
        }

        // Milestone filter (OR within category)
        if (advancedFilters.milestone.size > 0) {
          const mKey = prop.milestone ? `${prop.milestone.current}/${prop.milestone.total}` : '';
          if (!advancedFilters.milestone.has(mKey)) return false;
        }

        // Portfolio filter (OR within category)
        if (advancedFilters.portfolio.size > 0 && !advancedFilters.portfolio.has(prop.portfolio)) {
          return false;
        }

        return true;
      });

      if (currentView === 'gallery') renderCards();
      else if (currentView === 'list') renderListView();
      else if (currentView === 'map') renderMapView();

      updateUrlParams();
      updateFilterButtonState();
      renderPriorityPills();
    }

    // Render filter modal options
    function renderFilterModal() {
      // Helper to create option HTML with close icon
      const createOption = (isSelected, filterKey, value, label) => `
        <div class="filter-option ${isSelected ? 'selected' : ''}" data-filter="${filterKey}" data-value="${value}">
          <span>${label}</span>
          <span class="material-icons-outlined close-icon">close</span>
        </div>
      `;

      // Nutzung (type)
      const typeContainer = document.getElementById('filterNutzung');
      typeContainer.innerHTML = filterOptions.type.map(t =>
        createOption(advancedFilters.type.has(t), 'type', t, t)
      ).join('');

      // Verkaufsjahr (year)
      const yearContainer = document.getElementById('filterYear');
      yearContainer.innerHTML = filterOptions.year.map(y =>
        createOption(advancedFilters.year.has(String(y)), 'year', y, y)
      ).join('');

      // Priorisierung (priority) - show all 5 options
      const priorityContainer = document.getElementById('filterPriority');
      const priorityLabels = {
        '0': 'Hohe Priorität',
        '1': 'Normale Priorität',
        '2': 'Geringe Priorität',
        '3': 'Keine Priorität',
        'null': 'Keine Angabe'
      };
      priorityContainer.innerHTML = ['0', '1', '2', '3', 'null'].map(pKey =>
        createOption(advancedFilters.priority.has(pKey), 'priority', pKey, priorityLabels[pKey])
      ).join('');

      // Meilenstein (milestone)
      const milestoneContainer = document.getElementById('filterMilestone');
      milestoneContainer.innerHTML = filterOptions.milestone.map(m =>
        createOption(advancedFilters.milestone.has(m.value), 'milestone', m.value, `${m.value} ${m.label}`)
      ).join('');

      // Portfolio
      const portfolioContainer = document.getElementById('filterPortfolio');
      portfolioContainer.innerHTML = filterOptions.portfolio.map(p =>
        createOption(advancedFilters.portfolio.has(p), 'portfolio', p, p)
      ).join('');

      // Add click handlers
      document.querySelectorAll('.filter-modal .filter-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const filterKey = opt.dataset.filter;
          const filterValue = opt.dataset.value;

          if (advancedFilters[filterKey].has(filterValue)) {
            advancedFilters[filterKey].delete(filterValue);
            opt.classList.remove('selected');
          } else {
            advancedFilters[filterKey].add(filterValue);
            opt.classList.add('selected');
          }

          applyFilters();
          // Update close icons visibility
          renderFilterModal();
        });
      });
    }

    // Filter Modal open/close
    function openFilterModal() {
      renderFilterModal();
      document.getElementById('filterModalOverlay').classList.add('active');
      document.getElementById('filterBtn').classList.add('panel-open');
      document.body.style.overflow = 'hidden';
    }

    function closeFilterModal() {
      document.getElementById('filterModalOverlay').classList.remove('active');
      document.getElementById('filterBtn').classList.remove('panel-open');
      document.body.style.overflow = '';
    }

    // --- Image Carousel Functions ---
    function openCarousel(images, startIndex = 0) {
      carouselImages = images;
      carouselIndex = startIndex;
      updateCarouselView();
      document.getElementById('carouselOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCarousel() {
      document.getElementById('carouselOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    function navigateCarousel(direction) {
      const newIndex = carouselIndex + direction;
      if (newIndex >= 0 && newIndex < carouselImages.length) {
        carouselIndex = newIndex;
        updateCarouselView();
      }
    }

    function goToCarouselImage(index) {
      if (index >= 0 && index < carouselImages.length) {
        carouselIndex = index;
        updateCarouselView();
      }
    }

    function updateCarouselView() {
      // Update counter
      document.getElementById('carouselCounter').textContent = `${carouselIndex + 1} / ${carouselImages.length}`;

      // Update main image with higher resolution
      const currentImage = carouselImages[carouselIndex].replace('w=400&h=300', 'w=1200&h=900');
      document.getElementById('carouselImage').src = currentImage;

      // Update navigation buttons
      document.querySelector('.carousel-nav-btn.prev').disabled = carouselIndex === 0;
      document.querySelector('.carousel-nav-btn.next').disabled = carouselIndex === carouselImages.length - 1;

      // Update thumbnails
      const thumbsContainer = document.getElementById('carouselThumbnails');
      thumbsContainer.innerHTML = carouselImages.map((img, idx) => `
        <div class="carousel-thumb ${idx === carouselIndex ? 'active' : ''}"
             style="background-image: url('${img}')"
             onclick="goToCarouselImage(${idx})"></div>
      `).join('');
    }

    function getDataToRender() { return (filteredProperties.length > 0 || hasActiveFilters()) ? filteredProperties : properties; }

    function renderCards() {
      const grid = document.getElementById('objectGrid');
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      grid.innerHTML = data.map(prop => `
        <div class="card" data-id="${prop.id}">
          <div class="card-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <div class="image-tags">
              <span class="year-tag" data-filter="year" data-value="${prop.year}">${prop.year}</span>
              <span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
            </div>
          </div>
          <div class="card-content">
            <div class="card-label">${prop.econUnit}/${prop.bldgNum} ${prop.type}</div>
            <div class="card-location">In ${prop.zip} ${prop.city}</div>
            <div class="card-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
            <div class="card-price-sqm">${formatCHF(pricePerSqm(prop.valueMin, prop.areaGF))} - ${formatCHF(pricePerSqm(prop.valueMax, prop.areaGF))} / m² GF</div>
            <div class="card-details">
              <span class="card-detail-label">Geschossfläche GF:</span><span class="card-detail-value">${prop.areaGF} m²</span>
              <span class="card-detail-label">Buchwert:</span><span class="card-detail-value">${formatCHF(prop.bookValue)}</span>
            </div>
            <div class="card-milestone">
              <div class="milestone-bar"><div class="milestone-progress" style="width: ${(prop.milestone.current / prop.milestone.total) * 100}%"></div></div>
              <div class="milestone-text">Meilenstein ${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</div>
            </div>
          </div>
        </div>`).join('');
    }

    function renderListView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const stats = { total: data.length, high: 0, normal: 0, low: 0 };
      data.forEach(p => {
        if (p.priorityLabel === 'Hohe Priorität') stats.high++;
        else if (p.priorityLabel === 'Normale Priorität') stats.normal++;
        else if (p.priorityLabel === 'Geringe Priorität') stats.low++;
      });
      document.getElementById('statsTotalObjects').textContent = stats.total;
      document.getElementById('statsHighPriority').textContent = stats.high;
      document.getElementById('statsNormalPriority').textContent = stats.normal;
      document.getElementById('statsLowPriority').textContent = stats.low;

      const tbody = document.getElementById('listTableBody');
      tbody.innerHTML = data.map(prop => `
        <tr data-id="${prop.id}">
          <td><span class="material-icons-outlined object-icon">home</span></td>
          <td>${prop.econUnit}/${prop.bldgNum}</td>
          <td>${prop.type} in ${prop.zip} ${prop.city}</td>
          <td><span class="year-tag" data-filter="year" data-value="${prop.year}">${prop.year}</span></td>
          <td><span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span></td>
          <td>${prop.milestone.current}/${prop.milestone.total} ${prop.milestone.label}</td>
          <td>${prop.areaGF} m²</td>
          <td>${formatPriceRange(prop.valueMin, prop.valueMax)}</td>
        </tr>`).join('');
    }

    // --- REPAIRED SIDEBAR RENDER FUNCTION ---
    function renderMapView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const sidebar = document.getElementById('mapSidebar');
      
      // Neue Struktur: Bild-Container mit Tags (Overlay) -> Inhalt (Name + Preis)
      sidebar.innerHTML = data.map(prop => `
        <div class="map-sidebar-item" data-id="${prop.id}">
          <div class="map-sidebar-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')">
            <div class="image-tags">
              <span class="year-tag" data-filter="year" data-value="${prop.year}">${prop.year}</span>
              <span class="priority-tag ${getPriorityClass(prop.priority)}" data-filter="priority" data-value="${getPriorityValue(prop.priority)}">${getPriorityLabel(prop.priority, prop.priorityLabel)}</span>
            </div>
          </div>
          <div class="map-sidebar-content">
            <div class="map-sidebar-title">${prop.type} in ${prop.zip} ${prop.city}</div>
            <div class="map-sidebar-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
          </div>
        </div>`).join('');

      if (!map) {
        initializeMap();
      } else if (mapLoaded) {
        updateMapMarkers(data);
      }
      // Wenn map existiert aber noch nicht geladen ist,
      // werden die Marker automatisch beim 'load'-Event aktualisiert
    }

    function flyToProperty(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop || !prop.lat || !prop.lng) return;
      document.querySelectorAll('.map-sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === id) item.classList.add('active');
      });
      document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
      const md = markersMap.get(id);
      if (md) {
        md.marker.getElement().classList.add('selected');
        map.flyTo({ center: [prop.lng, prop.lat], zoom: 13, duration: 1500 });
        setTimeout(() => {
          const popup = md.marker.getPopup();
          if (popup && !popup.isOpen()) {
            md.marker.togglePopup();
          }
        }, 1600);
      }
    }

    function initializeMap() {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [8.2275, 46.8182], zoom: 7
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      map.on('load', () => {
        mapLoaded = true;
        updateMapMarkers(getDataToRender());
      });
    }

    function updateMapMarkers(data) {
      markers.forEach(marker => marker.remove());
      markers = []; markersMap.clear();
      const bounds = new mapboxgl.LngLatBounds();
      data.forEach(prop => {
        if (prop.lat && prop.lng) {
          const el = document.createElement('div');
          el.className = `marker marker-${prop.priority !== null ? prop.priority : 'null'}`;
          el.innerHTML = '<span class="material-icons-outlined">home</span>';
          el.addEventListener('click', () => {
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
            flyToProperty(prop.id);
          });

          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div class="popup-image" style="background-image: url('${getPlaceholderImage(prop.type, prop.id)}')"></div>
            <div class="popup-content">
              <div class="popup-title">${prop.type}</div>
              <div class="popup-location">${prop.address}, ${prop.city}</div>
              <div class="popup-price">${formatPriceRange(prop.valueMin, prop.valueMax)}</div>
            </div>`);

          const marker = new mapboxgl.Marker(el).setLngLat([prop.lng, prop.lat]).setPopup(popup).addTo(map);
          markers.push(marker);
          markersMap.set(prop.id, { marker, prop });
          bounds.extend([prop.lng, prop.lat]);
        }
      });
      if (markers.length > 0) map.fitBounds(bounds, { padding: 80, maxZoom: 10 });
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        const label = btn.querySelector('.view-btn-label');
        if (label) label.remove();
      });
      const activeBtn = document.querySelector(`.view-btn[data-view="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        const label = document.createElement('span');
        label.className = 'view-btn-label';
        label.textContent = { gallery: 'Galerie', list: 'Liste', map: 'Karte' }[view];
        activeBtn.appendChild(label);
      }

      document.getElementById('galleryView').classList.remove('active');
      document.getElementById('listView').classList.remove('active');
      document.getElementById('mapView').classList.remove('active');

      if (view === 'gallery') {
        document.getElementById('galleryView').classList.add('active');
        renderCards();
      } else if (view === 'list') {
        document.getElementById('listView').classList.add('active');
        renderListView();
      } else if (view === 'map') {
        document.getElementById('mapView').classList.add('active');
        renderMapView();
        setTimeout(() => { if (map) map.resize(); }, 150);
      }
      updateUrlParams();
    }

    function setupViewToggle() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          if (view) setView(view);
        });
      });
    }

    function exportToExcel() { alert('Excel Export Placeholder'); }

    function setupFilterModal() {
      // Open filter modal
      document.getElementById('filterBtn').addEventListener('click', openFilterModal);

      // Close filter modal
      document.getElementById('filterCloseBtn').addEventListener('click', closeFilterModal);
      document.getElementById('filterModalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeFilterModal();
      });

      // Reset filters button in modal
      document.getElementById('filterResetBtn').addEventListener('click', () => {
        resetAllFilters();
      });

      // Keyboard navigation (handles carousel, filter modal, and detail view)
      document.addEventListener('keydown', (e) => {
        const carouselActive = document.getElementById('carouselOverlay').classList.contains('active');

        // Carousel keyboard controls
        if (carouselActive) {
          if (e.key === 'Escape') {
            closeCarousel();
          } else if (e.key === 'ArrowLeft') {
            navigateCarousel(-1);
          } else if (e.key === 'ArrowRight') {
            navigateCarousel(1);
          }
          return;
        }

        // Other Escape handlers
        if (e.key === 'Escape') {
          if (document.getElementById('filterModalOverlay').classList.contains('active')) {
            closeFilterModal();
          }
        }
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchQuery = e.target.value.trim();
          applyFilters();
        }, 300);
      });
    }

    // Canton code mapping for SVG highlighting (Wikipedia SVG uses canton codes directly)
    const cantonCodeMap = {
      'AG': 'AG', 'AI': 'AI', 'AR': 'AR', 'BE': 'BE', 'BL': 'BL',
      'BS': 'BS', 'FR': 'FR', 'GE': 'GE', 'GL': 'GL', 'GR': 'GR',
      'JU': 'JU', 'LU': 'LU', 'NE': 'NE', 'NW': 'NW', 'OW': 'OW',
      'SG': 'SG', 'SH': 'SH', 'SO': 'SO', 'SZ': 'SZ', 'TG': 'TG',
      'TI': 'TI', 'UR': 'UR', 'VD': 'VD', 'VS': 'VS', 'ZG': 'ZG', 'ZH': 'ZH'
    };

    // Open login dialog
    function openLoginDialog() {
      const overlay = document.getElementById('loginDialogOverlay');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Clear form
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // Close login dialog
    function closeLoginDialog() {
      const overlay = document.getElementById('loginDialogOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Submit login (mockup - just closes dialog)
    function submitLogin() {
      closeLoginDialog();
    }

    // Unified click handler (event delegation for tags and sidebar items)
    function handleContentClick(event) {
      // First, check if clicked on a filter tag
      const tag = event.target.closest('.priority-tag[data-filter], .year-tag[data-filter]');
      if (tag) {
        event.stopPropagation();
        event.preventDefault();

        const filterType = tag.dataset.filter;
        const filterValue = tag.dataset.value;

        // Add the filter
        advancedFilters[filterType].add(filterValue);

        applyFilters();

        // Update filter modal if it's open
        if (document.getElementById('filterModalOverlay').classList.contains('active')) {
          renderFilterModal();
        }
        return;
      }

      // Check if clicked on a map sidebar item
      const sidebarItem = event.target.closest('.map-sidebar-item[data-id]');
      if (sidebarItem) {
        flyToProperty(sidebarItem.dataset.id);
        return;
      }
    }

    // Set up unified event delegation
    document.addEventListener('click', handleContentClick);

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');

      if (view && ['gallery', 'list', 'map'].includes(view)) {
        setView(view);
      }
    });

    // --- INIT ---
    setupFilterModal();
    setupSearch();
    setupViewToggle();
    loadFiltersFromUrl();
    setView(currentView);

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        properties = data;
        filteredProperties = [...data];
        extractFilterOptions();
        applyFilters();
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('objectGrid').innerHTML = `<div style="grid-column: 1/-1; padding: 20px; text-align: center; background: white;">Fehler beim Laden. Starte via Live Server.</div>`;
      });
  </script>
</body>
</html>
