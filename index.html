<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bauprojekte - Bundesamt für Bauten und Logistik</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <style>
    /* --- Design Tokens (Modern Unified Color Scheme) --- */
    :root {
      /* Primary Palette - Brand Colors */
      --primary-900: #383E54;
      --primary-700: #2D3748;
      --primary-500: #4A5568;
      --primary-100: #EDF2F7;

      /* Accent Palette - Unified Teal (Complete Scale) */
      --accent-700: #005F8A;
      --accent-600: #0077B6;
      --accent-500: #0096C7;
      --accent-400: #00B4D8;
      --accent-300: #48CAE4;
      --accent-200: #90E0EF;
      --accent-100: #CAF0F8;
      --accent-50: #E0F7FA;

      /* Neutral Palette - Enhanced Contrast Gray Scale
         Adjusted for better visibility of borders/dividers against white backgrounds */
      --neutral-900: #111827;
      --neutral-800: #1F2937;
      --neutral-700: #374151;
      --neutral-600: #4B5563;
      --neutral-500: #6B7280;
      --neutral-400: #8891A0;
      --neutral-300: #B0B8C4;
      --neutral-200: #D1D5DB;
      --neutral-100: #F1F5F9;
      --neutral-50: #FFFFFF;

      /* Priority Colors - Semantic Status Indicators
         Design Decision: Colors map to urgency/attention levels:
         - High (Red): Critical, requires immediate attention
         - Medium (Amber): Moderate priority, review soon
         - Standard (Green): Active/on-track, proceeding normally
         - Low (Blue): Informational, lower urgency
         - None (Gray): Inactive, archived, or no priority assigned
      */
      --priority-high: #DC2626;
      --priority-high-bg: #FEE2E2;
      --priority-high-text: #B91C1C;
      --priority-high-marker: #DC2626;

      /* Medium Priority - Amber (new tier for moderate urgency) */
      --priority-medium: #F59E0B;
      --priority-medium-bg: #FEF3C7;
      --priority-medium-text: #B45309;
      --priority-medium-marker: #F59E0B;

      /* Standard/Normal - Green indicates "on track" or "active" status */
      --priority-normal: #10B981;
      --priority-normal-bg: #D1FAE5;
      --priority-normal-text: #047857;
      --priority-normal-marker: #10B981;
      /* Semantic alias for clarity */
      --priority-standard: var(--priority-normal);
      --priority-standard-bg: var(--priority-normal-bg);
      --priority-standard-text: var(--priority-normal-text);

      --priority-low: #3B82F6;
      --priority-low-bg: #DBEAFE;
      --priority-low-text: #1D4ED8;
      --priority-low-marker: #3B82F6;

      --priority-none: #9CA3AF;
      --priority-none-bg: #F3F4F6;
      --priority-none-text: #6B7280;
      --priority-none-marker: #9CA3AF;

      --priority-null-bg: #F9FAFB;
      --priority-null-text: #9CA3AF;
      --priority-null-border: #E5E7EB;
      --priority-null-marker: #D1D5DB;

      /* Warning Colors - Caution/Attention States */
      --warning: #F59E0B;
      --warning-bg: #FEF3C7;
      --warning-text: #B45309;
      --warning-border: #FCD34D;

      /* Semantic Colors */
      --color-star: #FFC107;
      --color-star-empty: var(--neutral-300);

      /* Spacing Scale (4px base unit) */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-9: 36px;
      --space-10: 40px;
      --space-12: 48px;

      /* Semantic Spacing Aliases */
      --spacing-section: var(--space-8);      /* 32px - Major section separation */
      --spacing-subsection: var(--space-6);   /* 24px - Subsection separation */
      --spacing-element: var(--space-4);      /* 16px - Element spacing */
      --spacing-tight: var(--space-2);        /* 8px - Tight spacing */
      --spacing-micro: var(--space-1);        /* 4px - Micro spacing */

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
      --radius-full: 9999px;

      /* Typography Scale */
      --font-size-xs: 12px;
      --font-size-sm: 13px;
      --font-size-base: 14px;
      --font-size-md: 15px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 32px;

      /* Font Weights */
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;

      /* Line Heights */
      --line-height-tight: 1.25;
      --line-height-normal: 1.5;
      --line-height-relaxed: 1.625;

      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.2s ease;
      --transition-slow: 0.3s ease;

      /* Interactive States */
      --state-hover-bg: #F7FAFC;
      --state-active-bg: var(--accent-600);
      --state-focus-ring: 0 0 0 3px rgba(0, 119, 182, 0.2);
      --state-focus-ring-accent: 0 0 0 3px rgba(0, 150, 199, 0.3);
      --state-disabled: #CBD5E0;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.15);

      /* Overlays */
      --overlay-bg: rgba(0, 0, 0, 0.5);
    }

    /* --- Reset & Base --- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--neutral-100); color: var(--neutral-900); line-height: var(--line-height-normal);
      display: flex; flex-direction: column; min-height: 100%;
      padding-bottom: 36px; /* Space for fixed footer */
    }

    /* --- Global Focus Styles (Accessibility) --- */
    :focus {
      outline: none;
    }
    :focus-visible {
      outline: 2px solid var(--accent-500);
      outline-offset: 2px;
    }
    /* Focus ring for buttons and interactive elements */
    button:focus-visible,
    [role="button"]:focus-visible,
    a:focus-visible {
      outline: 2px solid var(--accent-500);
      outline-offset: 2px;
    }
    /* Focus ring for form inputs */
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: none;
      border-color: var(--accent-600);
      box-shadow: var(--state-focus-ring);
    }
    /* Skip link for keyboard navigation */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent-600);
      color: var(--neutral-50);
      padding: var(--space-2) var(--space-4);
      z-index: 9999;
      transition: top var(--transition-normal);
    }
    .skip-link:focus {
      top: 0;
    }

    /* --- Header --- */
    .header {
      background-color: var(--primary-900); color: var(--neutral-50); padding: 0 var(--space-6);
      display: flex; align-items: center; justify-content: space-between;
      height: 64px; flex-shrink: 0;
    }
    .header-left { display: flex; align-items: center; gap: var(--space-4); }
    .logo {
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .header-title { display: flex; flex-direction: column; line-height: 1.3; }
    .header-title-main { font-size: 12px; font-weight: 600; }
    .header-title-sub { font-size: 12px; opacity: 0.9; }
    .header-right { display: flex; gap: var(--space-4); }
    .btn {
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      border: none;
      transition: background-color var(--transition-normal), box-shadow var(--transition-normal);
    }
    .btn:focus-visible {
      outline: 2px solid var(--accent-300);
      outline-offset: 2px;
    }
    .btn-primary { background-color: var(--accent-600); color: var(--neutral-50); }
    .btn-primary:hover { background-color: var(--accent-500); }
    .btn-outline { background-color: transparent; color: var(--neutral-50); border: 1px solid var(--neutral-50); }
    .btn-outline:hover { background-color: rgba(255,255,255,0.1); }

    /* --- Search & Filter --- */
    .search-section { background: var(--neutral-50); padding: var(--space-4) 0; flex-shrink: 0; border-bottom: 1px solid var(--neutral-200); }
    .search-section-inner { max-width: 1440px; margin: 0 auto; padding: 0 var(--space-6); }
    .search-row { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-4); }
    .search-input-wrapper { flex: 1; position: relative; }
    .search-input-wrapper .material-icons-outlined {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      color: var(--neutral-500); font-size: 20px;
    }
    .search-input {
      width: 100%; padding: var(--space-3) var(--space-4) var(--space-3) 44px;
      border: 1px solid var(--neutral-200); border-radius: 6px; font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-input:focus { outline: none; border-color: var(--accent-600); box-shadow: var(--state-focus-ring); }
    .view-toggle { display: flex; background: var(--neutral-100); border-radius: var(--radius-md); padding: var(--space-1); }
    .view-toggle .material-icons-outlined { font-size: 20px; }
    .view-btn {
      padding: var(--space-2) var(--space-3); border: none; background: transparent; cursor: pointer;
      border-radius: var(--radius-sm); color: var(--neutral-500); display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    }
    .view-btn:hover { color: var(--neutral-900); }
    .view-btn.active { background: var(--accent-600); color: var(--neutral-50); box-shadow: var(--shadow-sm); }
    .view-btn-label { font-size: 13px; font-weight: 500; margin-left: 6px; }

    /* --- Filter Row & Priority Pills --- */
    .filter-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: var(--space-3); }
    .filter-pills { display: flex; flex-wrap: wrap; gap: var(--space-2); align-items: center; flex: 1; }
    .filter-pill {
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      background: var(--neutral-50);
      color: var(--neutral-700);
      cursor: pointer;
      transition: all var(--transition-normal);
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
    }
    .filter-pill:hover { border-color: var(--neutral-300); background: var(--neutral-100); }
    .filter-pill:focus-visible { outline: 2px solid var(--accent-500); outline-offset: 2px; }
    .filter-pill.active { background: var(--accent-600); border-color: var(--accent-600); color: var(--neutral-50); }
    .filter-pill .close-icon { display: none; font-size: 16px; margin-left: 2px; margin-right: -4px; }
    .filter-pill.active .close-icon { display: inline; }
    .reset-filters {
      display: none; align-items: center; justify-content: center; padding: var(--space-2);
      border: none; background: transparent; color: var(--neutral-500); cursor: pointer;
      border-radius: var(--radius-sm); transition: all var(--transition-normal);
    }
    .reset-filters.visible { display: flex; }
    .reset-filters:hover { background: var(--neutral-100); color: var(--neutral-900); }
    .filter-right { display: flex; align-items: center; gap: var(--space-4); }
    .stats-count { font-size: 14px; color: var(--neutral-700); font-weight: 600; }
    .filter-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-full);
      background: var(--neutral-50);
      font-size: var(--font-size-sm);
      color: var(--neutral-700);
      cursor: pointer;
      transition: all var(--transition-normal);
    }
    .filter-btn .material-icons-outlined { font-size: 20px; }
    .filter-btn:hover { border-color: var(--accent-600); color: var(--accent-600); }
    .filter-btn:focus-visible { outline: 2px solid var(--accent-500); outline-offset: 2px; }
    .filter-btn.has-filters { border-color: var(--accent-600); color: var(--accent-600); background: var(--accent-100); }
    .filter-btn.panel-open { border-color: var(--accent-600); color: var(--neutral-50); background: var(--accent-600); }
    .filter-btn .filter-count {
      background: var(--accent-600); color: var(--neutral-50); font-size: 11px; font-weight: 600;
      padding: 2px 6px; border-radius: 10px; margin-left: 2px;
    }

    /* --- Filter Modal --- */
    .filter-modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg); display: flex; align-items: flex-start; justify-content: center;
      padding: 80px 20px 40px; z-index: 1000; overflow-y: auto;
      opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .filter-modal-overlay.active { opacity: 1; visibility: visible; }
    .filter-modal {
      background: var(--neutral-50); border-radius: 12px; width: 100%; max-width: 900px;
      box-shadow: var(--shadow-xl);
      transform: translateY(-20px); transition: transform 0.3s;
    }
    .filter-modal-overlay.active .filter-modal { transform: translateY(0); }
    .filter-modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: var(--space-5) var(--space-6); border-bottom: 1px solid var(--neutral-200);
    }
    .filter-modal-header h2 { font-size: 18px; font-weight: 600; color: var(--neutral-900); margin: 0; }
    .filter-modal-actions { display: flex; align-items: center; gap: var(--space-2); }
    .filter-reset-btn, .filter-close-btn {
      width: 36px; height: 36px; border: none; background: var(--neutral-100);
      border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; color: var(--neutral-500);
    }
    .filter-reset-btn:hover, .filter-close-btn:hover { background: var(--neutral-200); color: var(--neutral-900); }
    .filter-modal-body { padding: var(--space-6); }
    .filter-columns { display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-6); }
    .filter-column-title { font-size: 14px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-4); }
    .filter-options { display: flex; flex-direction: column; gap: var(--space-2); }
    .filter-option {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      background: var(--neutral-100);
      color: var(--neutral-700);
      cursor: pointer;
      transition: all var(--transition-normal);
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .filter-option:hover { background: var(--state-hover-bg); border-color: var(--neutral-200); }
    .filter-option:focus-visible { outline: 2px solid var(--accent-500); outline-offset: 2px; }
    .filter-option.selected { background: var(--accent-600); color: var(--neutral-50); border-color: var(--accent-600); }
    .filter-option .close-icon { display: none; font-size: 16px; opacity: 0.7; }
    .filter-option.selected .close-icon { display: inline; }
    .filter-option.selected:hover .close-icon { opacity: 1; }

    @media (max-width: 900px) {
      .filter-columns { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 640px) {
      .filter-columns { grid-template-columns: repeat(2, 1fr); }
      .filter-modal { margin: 10px; max-width: calc(100% - 20px); }
    }

    /* --- Main Layout --- */
    .main {
      max-width: 1440px; margin: 0 auto; padding: var(--space-6);
      flex: 1; display: flex; flex-direction: column; min-height: 0; width: 100%;
    }

    /* --- Gallery Grid --- */
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-6); }
    @media (max-width: 1200px) { .grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

    /* --- Card Style --- */
    .card {
      background: var(--neutral-50); border-radius: 8px; overflow: hidden;
      box-shadow: var(--shadow-md); cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
    .card-image { position: relative; height: 180px; background-color: var(--neutral-200); background-size: cover; background-position: center; }
    /* Tag Style Shared */
    .status-tag { display: inline-block; padding: var(--space-1) var(--space-3); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; box-shadow: var(--shadow-sm); }
    .status-active { background-color: var(--priority-normal-bg); color: var(--priority-normal-text); }
    .status-inactive { background-color: var(--priority-none-bg); color: var(--priority-none-text); }
    .status-pending { background-color: var(--warning-bg); color: var(--warning-text); }
    .status-sold { background-color: var(--priority-low-bg); color: var(--priority-low-text); }
    .status-unknown { background-color: var(--priority-null-bg); color: var(--priority-null-text); border: 1px solid var(--priority-null-border); }

    /* Image Tags Container */
    .image-tags { position: absolute; top: var(--space-3); left: var(--space-3); display: flex; gap: var(--space-2); z-index: 2; }

    /* Clickable tag styles */
    .status-tag[data-filter] { cursor: pointer; transition: transform 0.15s, filter 0.15s; }
    .status-tag[data-filter]:hover { transform: scale(1.05); filter: brightness(0.95); }

    .card-badge { position: absolute; top: var(--space-3); left: var(--space-3); }
    .card-content { padding: var(--space-5); }  /* 20px for better breathing room */
    .card-label { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .card-location { font-size: 13px; color: var(--neutral-700); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid var(--neutral-200); }
    .card-price { font-size: 15px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .card-price-sqm { font-size: 12px; color: var(--neutral-500); margin-bottom: var(--space-3); padding-bottom: var(--space-3); border-bottom: 1px solid var(--neutral-200); }
    .card-details { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2); font-size: 13px; margin-bottom: var(--space-3); }
    .card-details:last-child { margin-bottom: 0; }
    .card-detail-label { color: var(--neutral-700); font-weight: 500; }
    .card-detail-value { color: var(--neutral-900); font-weight: 500; }
    .card-milestone { padding-top: 0px; }
    .milestone-bar { height: 6px; background: var(--neutral-200); border-radius: 3px; overflow: hidden; margin-bottom: var(--space-2); }
    .milestone-progress { height: 100%; background: linear-gradient(90deg, var(--accent-600), var(--accent-500)); border-radius: 3px; transition: width 0.3s; }
    .milestone-text { font-size: 13px; color: var(--neutral-700); font-weight: 500; }

    /* --- List View --- */
    .view-container { display: none; }
    .view-container.active { display: block; }
    .stats-boxes { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-4); margin-bottom: var(--space-6); max-width: 400px; }
    .stats-box { background: var(--neutral-50); border-radius: var(--radius-lg); padding: var(--space-5); text-align: center; box-shadow: var(--shadow-md); }
    .stats-box-value { font-size: 32px; font-weight: 600; color: var(--neutral-900); margin-bottom: var(--space-1); }
    .stats-box-label { font-size: 13px; color: var(--neutral-500); }
    .stats-box-download { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
    .stats-box-download:hover { background-color: var(--neutral-100); }
    .stats-box-download .material-icons-outlined { font-size: 32px; color: var(--neutral-500); margin-bottom: var(--space-1); }
    .list-table-container { background: var(--neutral-50); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); }
    .list-table { width: 100%; border-collapse: collapse; }
    .list-table th { background: var(--neutral-100); padding: var(--space-4); text-align: left; font-size: 13px; font-weight: 600; color: var(--neutral-700); border-bottom: 1px solid var(--neutral-200); }
    .list-table td { padding: var(--space-4); font-size: 14px; color: var(--neutral-900); border-bottom: 1px solid var(--neutral-200); vertical-align: middle; }
    .list-table tbody tr:hover { background-color: var(--neutral-100); cursor: pointer; }
    .object-cell { display: flex; align-items: center; gap: var(--space-3); }
    .object-icon { color: var(--neutral-500); font-size: 20px; }
    .milestone-text-small { font-size: 12px; color: var(--neutral-500); }

    /* --- MAP VIEW & SIDEBAR FIXES --- */
    .map-container {
        display: none; width: 100%;
        flex: 1; min-height: 0;
        background: var(--neutral-50); border-radius: 8px; overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    .map-container.active { display: grid; grid-template-columns: 320px 1fr; grid-template-rows: 1fr; max-height: 1200px; }

    .map-sidebar {
        width: 100%; height: 100%;
        background: var(--neutral-50); overflow-y: auto;
        border-right: 1px solid var(--neutral-200);
        scrollbar-width: thin;
    }

    /* Sidebar Item Fixes */
    .map-sidebar-item {
        padding: var(--space-4);
        border-bottom: 1px solid var(--neutral-200);
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column; /* Stack: Image top, Text bottom */
        gap: var(--space-3);
    }
    .map-sidebar-item:hover { background-color: var(--neutral-100); }
    .map-sidebar-item.active { background-color: var(--accent-100); padding-left: var(--space-3); border-left: 3px solid var(--accent-600); } /* Highlight style */

    .map-sidebar-image {
        position: relative;
        width: 100%;
        height: 160px; /* Fixed Height für Bild */
        background-color: var(--neutral-200);
        background-size: cover;
        background-position: center;
        border-radius: 6px;
        overflow: hidden;
    }
    /* Tags im Bild oben links */
    .map-sidebar-image .image-tags {
        top: 10px;
        left: 10px;
    }

    .map-sidebar-content { display: flex; flex-direction: column; gap: var(--space-1); }
    .map-sidebar-title { font-size: 15px; font-weight: 600; color: var(--neutral-900); line-height: 1.3; }
    .map-sidebar-price { font-size: 14px; font-weight: 600; color: var(--accent-600); margin-top: var(--space-1); }

    .map-area { position: relative; width: 100%; height: 100%; background-color: var(--neutral-200); overflow: hidden; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; }

    /* Map Markers */
    .marker {
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid var(--neutral-50);
        /* Enhanced shadow for visibility on satellite/terrain maps */
        box-shadow:
          0 2px 6px rgba(0,0,0,0.4),
          0 0 0 1px rgba(255,255,255,0.3),
          0 4px 12px rgba(0,0,0,0.25);
    }
    .marker-active { background-color: var(--priority-normal-marker); }
    .marker-inactive { background-color: var(--priority-none-marker); }
    .marker-pending { background-color: var(--warning); }
    .marker-sold { background-color: var(--priority-low-marker); }
    .marker-unknown { background-color: var(--priority-null-marker); }
    .marker .material-icons-outlined { color: var(--neutral-50); font-size: 16px; }
    .marker.selected {
        border: 3px solid var(--accent-600);
        transform: scale(1.15);
        z-index: 10;
        box-shadow:
          0 2px 6px rgba(0,0,0,0.4),
          0 0 0 2px rgba(0, 119, 182, 0.5),
          0 4px 16px rgba(0,0,0,0.3);
    }

    .mapboxgl-popup-content { padding: 0; border-radius: 8px; overflow: hidden; min-width: 250px; }
    .popup-image { height: 120px; background-size: cover; background-position: center; }
    .popup-content { padding: var(--space-3); }
    .popup-title { font-weight: 600; margin-bottom: var(--space-1); }
    .popup-link { display: block; text-align: center; padding: var(--space-2) var(--space-3); background: var(--primary-900); color: var(--neutral-50); text-decoration: none; border-radius: var(--radius-sm); margin-top: var(--space-2); cursor: pointer; }

    /* Responsive */
    @media (max-width: 900px) { .stats-boxes { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) {
        .map-container.active { display: flex; flex-direction: column; height: auto; }
        .map-sidebar { width: 100%; max-height: 250px; border-right: none; border-bottom: 1px solid var(--neutral-200); }
        .map-area { height: 400px; width: 100%; }
        .map-sidebar-image { height: 120px; } /* Kleineres Bild auf Mobile */
    }
    @media (max-width: 640px) {
        .header { padding: 12px 16px; height: auto; flex-wrap: wrap; gap: 12px; }
        .search-row, .filter-row { flex-direction: column; align-items: stretch; }
        .grid { grid-template-columns: 1fr; }
    }

    /* --- Footer --- */
    .footer {
      background-color: var(--primary-900);
      color: var(--neutral-50);
      padding: var(--space-1) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: left;
      gap: var(--space-8);
      flex-shrink: 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 36px;
      z-index: 101;
    }
    .footer-link {
      color: var(--neutral-50);
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.2s;
    }
    .footer-link:hover {
      opacity: 0.8;
    }

    /* --- Image Carousel --- */
    .carousel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .carousel-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .carousel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      color: var(--neutral-50);
    }
    .carousel-counter {
      font-size: 14px;
      font-weight: 500;
    }
    .carousel-close-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      transition: background 0.2s;
    }
    .carousel-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .carousel-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0;
      padding: 0 80px;
    }
    .carousel-image-container {
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .carousel-image {
      max-width: 100%;
      max-height: calc(100vh - 200px);
      object-fit: contain;
      border-radius: 4px;
    }
    .carousel-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--neutral-50);
      transition: background 0.2s;
      z-index: 10;
    }
    .carousel-nav-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .carousel-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .carousel-nav-btn.prev {
      left: 16px;
    }
    .carousel-nav-btn.next {
      right: 16px;
    }
    .carousel-thumbnails {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 16px 24px 24px;
      overflow-x: auto;
    }
    .carousel-thumb {
      width: 64px;
      height: 48px;
      border-radius: 4px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s, box-shadow 0.2s;
      flex-shrink: 0;
      border: 2px solid transparent;
    }
    .carousel-thumb:hover {
      opacity: 0.8;
    }
    .carousel-thumb.active {
      opacity: 1;
      border-color: var(--accent-500);
      box-shadow: 0 0 0 2px rgba(0, 150, 199, 0.3);
    }

    /* Clickable gallery images - zoom effect via pseudo-element */
    .detail-main-image.clickable,
    .detail-thumb.clickable {
      cursor: pointer;
      overflow: hidden;
    }
    .detail-main-image.clickable::before,
    .detail-thumb.clickable::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: inherit;
      border-radius: inherit;
      z-index: 1;
      transition: transform 0.3s ease;
    }
    .detail-main-image.clickable:hover::before,
    .detail-thumb.clickable:hover::before {
      transform: scale(1.05);
    }

    /* Carousel responsive */
    @media (max-width: 768px) {
      .carousel-main {
        padding: 0 16px;
      }
      .carousel-nav-btn {
        width: 40px;
        height: 40px;
      }
      .carousel-nav-btn.prev {
        left: 8px;
      }
      .carousel-nav-btn.next {
        right: 8px;
      }
      .carousel-thumb {
        width: 48px;
        height: 36px;
      }
    }

    /* --- Tab Content Visibility --- */
    .tab-content-uebersicht,
    .tab-content-dokumente {
      display: none;
    }
    .tab-content-uebersicht.active,
    .tab-content-dokumente.active {
      display: block;
    }

    /* --- Shared Tab Container Styles --- */
    .tab-container { padding: 0; }
    .tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 16px 0;
    }
    .tab-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .tab-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0 16px 0;
      gap: 16px;
    }
    .tab-search {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      padding: 8px 12px;
      min-width: 240px;
    }
    .tab-search .material-icons-outlined {
      color: var(--neutral-400);
      font-size: 20px;
    }
    .tab-search input {
      border: none;
      outline: none;
      font-size: 14px;
      color: var(--neutral-700);
      background: transparent;
      width: 100%;
    }
    .tab-search input::placeholder { color: var(--neutral-400); }
    .tab-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* --- Shared Table Action Button Styles --- */
    .table-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--neutral-400);
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: not-allowed;
      transition: all 0.2s;
    }
    .table-action-btn .material-icons-outlined { font-size: 18px; }
    .table-action-btn.active {
      color: var(--neutral-600);
      cursor: pointer;
    }
    .table-action-btn.active:hover {
      background: var(--neutral-100);
      color: var(--neutral-900);
    }
    .table-btn-outline {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--neutral-300);
      background: transparent;
      color: var(--neutral-700);
      font-size: 14px;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .table-btn-outline:hover {
      background: var(--neutral-100);
      border-color: var(--neutral-400);
    }
    .table-btn-outline .material-icons-outlined { font-size: 18px; }

    /* --- Shared Data Table Styles --- */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th,
    .data-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--neutral-200);
    }
    .data-table th {
      font-size: 13px;
      font-weight: 600;
      color: var(--neutral-700);
      background: var(--neutral-100);
      white-space: nowrap;
    }
    .data-table td {
      font-size: 14px;
      color: var(--neutral-900);
    }
    .data-table tbody tr:hover td { background: var(--neutral-100); }
    .data-table tbody tr.selected td { background: var(--accent-50); }
    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
    }
    .data-table th.sortable:hover { color: var(--neutral-900); }
    .data-table th .sort-icon {
      font-size: 16px;
      vertical-align: middle;
      margin-left: 2px;
      opacity: 0.5;
    }
    .data-table th.sortable:hover .sort-icon { opacity: 1; }
    .data-table-checkbox { width: 48px; }
    .data-table-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--accent-600);
    }

    /* --- Shared Empty State --- */
    .tab-empty {
      text-align: center;
      padding: 48px 24px;
      color: var(--neutral-500);
    }
    .tab-empty .material-icons-outlined {
      font-size: 48px;
      color: var(--neutral-300);
      margin-bottom: 16px;
    }

    /* --- Documents Tab Specific --- */
    .doc-title a {
      color: var(--neutral-900);
      text-decoration: none;
      transition: color 0.2s;
    }
    .doc-title a:hover {
      color: var(--accent-600);
      text-decoration: underline;
    }

    /* --- Events Tab Specific --- */
    .tab-content-ereignisse { display: none; }
    .tab-content-ereignisse.active { display: block; }

    /* --- Meilensteine Tab Specific --- */
    .tab-content-meilensteine { display: none; }
    .tab-content-meilensteine.active { display: block; }

    .milestone-list {
      display: flex;
      flex-direction: column;
    }

    .milestone-item {
      display: flex;
      align-items: flex-start;
      padding: var(--space-6) 0;
      border-bottom: 1px solid var(--neutral-200);
    }

    .milestone-item:last-child {
      border-bottom: none;
    }

    .milestone-content {
      flex: 1;
      min-width: 0;
    }

    .milestone-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--neutral-900);
      margin-bottom: var(--space-2);
    }

    .milestone-status {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
    }

    .milestone-status-icon {
      font-size: 20px;
    }

    .milestone-status-icon.completed {
      color: var(--priority-normal);
    }

    .milestone-status-icon.pending {
      color: var(--neutral-300);
    }

    .milestone-status-text {
      font-size: 14px;
      color: var(--neutral-600);
    }

    .milestone-responsibility {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-full);
      font-size: 12px;
      color: var(--neutral-600);
      background: var(--neutral-50);
    }

    .milestone-action {
      flex-shrink: 0;
      margin-left: var(--space-6);
    }

    .milestone-btn {
      padding: var(--space-2) var(--space-5);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .milestone-btn-complete {
      background: var(--accent-600);
      color: var(--neutral-50);
      border: 1px solid var(--accent-600);
    }

    .milestone-btn-complete:hover {
      background: var(--accent-500);
      border-color: var(--accent-500);
    }

    .milestone-btn-completed {
      background: var(--neutral-50);
      color: var(--neutral-500);
      border: 1px solid var(--neutral-300);
      cursor: default;
    }

    .milestone-btn-pending {
      background: var(--neutral-100);
      color: var(--neutral-400);
      border: 1px solid var(--neutral-200);
      cursor: not-allowed;
    }

    /* --- Upload Dialog Overlay --- */
    .upload-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .upload-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .upload-dialog {
      background: var(--neutral-50);
      border-radius: 12px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .upload-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--neutral-200);
    }
    .upload-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .upload-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--neutral-500);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .upload-dialog-close:hover {
      background: var(--neutral-100);
    }
    .upload-step {
      padding: 16px 24px;
    }
    .upload-step:first-of-type {
      padding-top: 24px;
    }
    .upload-step-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: 8px;
    }
    .upload-dropzone {
      border: 2px dashed var(--neutral-300);
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-dropzone:hover {
      border-color: var(--accent-600);
      background: var(--accent-100);
    }
    .upload-dropzone.dragover {
      border-color: var(--accent-600);
      background: var(--accent-100);
    }
    .upload-dropzone.has-file {
      border-color: var(--accent-600);
      border-style: solid;
      background: var(--accent-100);
    }
    .upload-dropzone-text {
      color: var(--neutral-500);
      font-size: 14px;
    }
    .upload-dropzone-filename {
      color: var(--accent-600);
      font-weight: 500;
    }
    .upload-select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      cursor: pointer;
    }
    .upload-select:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .upload-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: 6px;
      background: var(--neutral-50);
      color: var(--neutral-700);
      box-sizing: border-box;
    }
    .upload-input:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .upload-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 20px 24px;
      border-top: 1px solid var(--neutral-200);
    }
    .upload-btn-cancel {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .upload-btn-cancel:hover {
      background: var(--neutral-100);
    }
    .upload-btn-submit {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: var(--accent-600);
      color: var(--neutral-50);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .upload-btn-submit:hover:not(:disabled) {
      background: var(--accent-500);
    }
    .upload-btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* --- Login Dialog Styles --- */
    .login-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .login-dialog-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .login-dialog {
      background: var(--neutral-50);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .login-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--neutral-200);
    }
    .login-dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--neutral-900);
      margin: 0;
    }
    .login-dialog-close {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--neutral-500);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .login-dialog-close:hover {
      background: var(--neutral-100);
    }
    .login-form {
      padding: var(--space-6);
    }
    .login-field {
      margin-bottom: var(--space-4);
    }
    .login-field:last-of-type {
      margin-bottom: 0;
    }
    .login-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-700);
      margin-bottom: var(--space-2);
    }
    .login-input {
      width: 100%;
      padding: var(--space-3);
      font-size: 14px;
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-md);
      background: var(--neutral-50);
      color: var(--neutral-700);
      box-sizing: border-box;
    }
    .login-input:focus {
      outline: none;
      border-color: var(--accent-600);
    }
    .login-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      padding: var(--space-5) var(--space-6);
      border-top: 1px solid var(--neutral-200);
    }
    .login-btn-cancel {
      padding: var(--space-3) var(--space-5);
      font-size: 14px;
      font-weight: 500;
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-btn-cancel:hover {
      background: var(--neutral-100);
    }
    .login-btn-submit {
      padding: var(--space-3) var(--space-5);
      font-size: 14px;
      font-weight: 500;
      border: none;
      background: var(--accent-600);
      color: var(--neutral-50);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.2s;
    }
    .login-btn-submit:hover {
      background: var(--accent-500);
    }
    .login-links {
      display: flex;
      justify-content: space-between;
      padding: 0 var(--space-6) var(--space-4);
    }
    .login-link {
      font-size: 13px;
      color: var(--accent-600);
      text-decoration: none;
      cursor: pointer;
    }
    .login-link:hover {
      text-decoration: underline;
    }

    /* --- Detail View Styles --- */
    .detail-view {
      display: none;
      position: fixed;
      top: 64px; /* Below header */
      left: 0;
      right: 0;
      bottom: 36px; /* Above footer */
      background: var(--neutral-100);
      z-index: 100;
      overflow-y: auto;
      flex-direction: column;
    }
    .detail-view.active {
      display: flex;
    }

    /* Detail Sub-Header (full-width) */
    .detail-subheader {
      background: var(--neutral-50);
      border-bottom: 1px solid var(--neutral-200);
      flex-shrink: 0;
    }
    .detail-subheader-inner {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4) 0;
      max-width: 1440px;
      margin: 0 auto;
    }
    .detail-header-icon {
      color: var(--neutral-500);
      font-size: 24px;
    }
    .detail-header-title {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: var(--neutral-900);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .detail-edit-btn,
    .detail-back-btn {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--neutral-300);
      background: var(--neutral-50);
      color: var(--neutral-700);
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .detail-edit-btn:hover,
    .detail-back-btn:hover {
      background: var(--neutral-100);
      border-color: var(--neutral-400);
    }
    .detail-edit-btn .material-icons-outlined,
    .detail-back-btn .material-icons-outlined {
      font-size: 18px;
    }

    /* Detail Body (contains sidebar + main) */
    .detail-body {
      display: flex;
      justify-content: center;
      padding-top: var(--space-6);
      margin-bottom: var(--space-6);
    }
    .detail-view-inner {
      display: grid;
      grid-template-columns: 280px 1fr;
      width: 100%;
      max-width: 1440px;
      background: var(--neutral-50);
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    /* Detail Sidebar */
    .detail-sidebar {
      border-right: 1px solid var(--neutral-200);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .detail-sidebar-header {
      padding: var(--space-4) var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
      font-size: 14px;
      font-weight: 600;
      color: var(--neutral-700);
      background: var(--neutral-50);
      position: sticky;
      top: 0;
      z-index: 1;
      /* Match height with detail-tabs (tab has space-4 padding + 2px border) */
      min-height: 54px;
      display: flex;
      align-items: center;
      box-sizing: border-box;
    }
    .detail-sidebar-list {
      flex: 1;
      overflow-y: auto;
    }
    .detail-sidebar-item {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    .detail-sidebar-item:hover {
      background-color: var(--neutral-100);
    }
    .detail-sidebar-item.active {
      background-color: var(--accent-100);
      border-left: 3px solid var(--accent-600);
      padding-left: calc(var(--space-4) - 3px);
    }
    .detail-sidebar-item .material-icons-outlined {
      color: var(--neutral-400);
      font-size: 20px;
    }
    .detail-sidebar-item.active .material-icons-outlined {
      color: var(--accent-600);
    }
    .detail-sidebar-item-text {
      font-size: 13px;
      color: var(--neutral-700);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .detail-sidebar-item.active .detail-sidebar-item-text {
      color: var(--neutral-900);
      font-weight: 500;
    }

    /* Detail Main Content */
    .detail-main {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Detail Tabs */
    .detail-tabs {
      display: flex;
      gap: 0;
      padding: 0 var(--space-6);
      background: var(--neutral-50);
      border-bottom: 1px solid var(--neutral-200);
      min-height: 54px;
      align-items: stretch;
    }
    .detail-tab {
      padding: var(--space-4) var(--space-5);
      font-size: 14px;
      font-weight: 500;
      color: var(--neutral-600);
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .detail-tab:hover {
      color: var(--neutral-900);
      background: var(--neutral-100);
    }
    .detail-tab.active {
      color: var(--accent-600);
      border-bottom-color: var(--accent-600);
    }
    .detail-tab:disabled {
      color: var(--neutral-400);
      cursor: not-allowed;
    }
    .detail-tab:disabled:hover {
      background: transparent;
    }

    /* Detail Content Area */
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-8) var(--space-10);  /* 32px vertical, 40px horizontal for breathing room */
    }

    /* ========================================
       UNIFIED TAB COMPONENTS
       Consistent styling across all detail tabs
       ======================================== */

    /* Tab Main Header - consistent title for all tabs */
    .tab-header {
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-semibold);
      color: var(--accent-700);
      margin-bottom: var(--space-6);
    }

    /* Tab Container - unified wrapper for tab content */
    .tab-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }
    .tab-container--constrained {
      max-width: 700px;
    }
    .tab-container--two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-10);
    }
    @media (max-width: 1024px) {
      .tab-container--two-column {
        grid-template-columns: 1fr;
        gap: var(--space-6);
      }
    }

    /* Tab Section - consistent section wrapper */
    .tab-section {
      margin-bottom: var(--space-4);
    }
    .tab-section-header {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--neutral-700);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--neutral-200);
      margin-bottom: var(--space-3);
    }

    /* Data Rows Container */
    .data-rows {
      display: flex;
      flex-direction: column;
    }

    /* Unified Data Row - flexible grid-based row component */
    .data-row {
      display: grid;
      grid-template-columns: var(--row-cols, 80px 1fr 80px 50px 60px);
      gap: var(--space-2);
      padding: var(--space-1) var(--space-1);
      align-items: center;
      border-radius: var(--radius-sm);
      transition: background-color var(--transition-fast);
    }
    .data-row:hover {
      background-color: var(--neutral-100);
    }
    .data-row--narrow {
      --row-cols: 110px 1fr 80px 60px;
    }
    .data-row--risk {
      --row-cols: 75px 1fr 100px;
      gap: var(--space-3);
    }

    /* Data Row Cell Types */
    .data-row__id {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--accent-700);
    }
    .data-row__label {
      font-size: var(--font-size-sm);
      color: var(--neutral-600);
    }
    .data-row__value {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--neutral-900);
      text-align: right;
    }
    .data-row__unit {
      font-size: var(--font-size-xs);
      color: var(--neutral-500);
      text-align: left;
    }
    .data-row__meta {
      font-size: var(--font-size-xs);
      color: var(--neutral-400);
      text-align: right;
    }

    /* Status Dots for Risk Indicators */
    .status-dots {
      display: flex;
      gap: var(--space-4);
      justify-content: flex-end;
    }
    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: var(--neutral-300);
      flex-shrink: 0;
    }
    .status-dot--low {
      background-color: #84cc16;
    }
    .status-dot--medium {
      background-color: #eab308;
    }
    .status-dot--high {
      background-color: #dc2626;
    }

    /* Unified Data Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--neutral-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: left;
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--neutral-200);
    }
    .data-table th:last-child {
      text-align: center;
      width: 100px;
    }
    .data-table td {
      font-size: var(--font-size-base);
      color: var(--neutral-700);
      padding: var(--space-3);
      border-bottom: 1px solid var(--neutral-100);
      vertical-align: middle;
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tbody tr:hover td {
      background-color: var(--neutral-100);
    }
    .data-table td:last-child {
      text-align: center;
    }

    /* BKP Cost Table */
    .bkp-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 60px;
    }
    .bkp-table th {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--neutral-700);
      text-align: left;
      padding: var(--space-1) var(--space-1);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--neutral-200);
    }
    .bkp-table td {
      font-size: var(--font-size-sm);
      color: var(--neutral-700);
      padding: var(--space-1) var(--space-1);
      vertical-align: middle;
    }
    .bkp-table td.text-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .bkp-table td.text-muted {
      color: var(--neutral-400);
    }
    .bkp-table tbody tr:hover td {
      background-color: var(--neutral-100);
    }
    .bkp-table tr.bkp-total td {
      padding-top: var(--space-2);
      border-top: 1px solid var(--neutral-300);
    }
    .bkp-table tr.bkp-spacer td {
      padding: var(--space-2) 0;
    }
    .bkp-table tr.bkp-summary td {
      font-weight: var(--font-weight-semibold);
      color: var(--neutral-900);
    }
    .bkp-table tr.bkp-summary .data-row__id {
      color: var(--neutral-700);
    }

    /* Table Status Badge */
    .table-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
    }
    .table-status--completed {
      background-color: var(--success-50);
      color: var(--success-700);
    }
    .table-status--pending {
      background-color: var(--neutral-100);
      color: var(--neutral-600);
    }

    /* Table Action Button */
    .table-action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-sm);
      background: white;
      color: var(--neutral-600);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .table-action-btn:hover {
      background: var(--neutral-100);
      border-color: var(--neutral-400);
      color: var(--neutral-700);
    }
    .table-action-btn--completed {
      background: var(--success-50);
      border-color: var(--success-200);
      color: var(--success-600);
    }
    .table-action-btn .material-icons-outlined {
      font-size: 18px;
    }

    /* Empty State */
    .empty-state {
      font-size: var(--font-size-base);
      color: var(--neutral-500);
      font-style: italic;
      padding: var(--space-4);
      text-align: center;
    }

    /* Responsive Data Rows */
    @media (max-width: 1024px) {
      .data-row {
        --row-cols: 95px 1fr 70px 45px 55px;
      }
      .data-row--narrow {
        --row-cols: 95px 1fr 70px 45px;
      }
    }
    @media (max-width: 768px) {
      .data-row {
        --row-cols: 85px 1fr 65px 40px;
      }
      .data-row__meta {
        display: none;
      }
      .data-row--narrow {
        --row-cols: 85px 1fr 65px 40px;
      }
      .data-row--risk {
        --row-cols: 70px 1fr 80px;
      }
      .status-dots {
        gap: var(--space-2);
      }
      .status-dot {
        width: 14px;
        height: 14px;
      }
    }

    /* ======================================== */

    /* Detail Media Section (Image + Map) */
    .detail-media {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
      margin-bottom: var(--space-6);
    }
    .detail-image {
      height: 280px;
      background-size: cover;
      background-position: center;
      background-color: var(--neutral-200);
      border-radius: var(--radius-lg);
    }
    .detail-map-container {
      height: 280px;
      border-radius: var(--radius-lg);
      overflow: hidden;
      position: relative;
      background-color: var(--neutral-200);
    }
    #detailMap {
      width: 100%;
      height: 100%;
    }

    /* Detail Fields Grid */
    .detail-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5) var(--space-6);  /* 20px row gap, 24px column gap for visual rhythm */
    }
    .detail-field {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    .detail-field-label {
      font-size: 12px;
      color: var(--neutral-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-field-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--neutral-900);
    }
    .detail-field-value.highlight {
      color: var(--accent-600);
    }

    /* Detail Info Message */
    .detail-info-message {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--neutral-100);
      border-radius: var(--radius-md);
      color: var(--neutral-600);
      font-size: 14px;
    }
    .detail-info-message .material-icons-outlined {
      font-size: 18px;
      color: var(--neutral-500);
    }

    /* Responsive Detail View */
    @media (max-width: 1024px) {
      .detail-view-inner {
        grid-template-columns: 240px 1fr;
      }
      .detail-content {
        padding: var(--space-6) var(--space-8);  /* 24px vertical, 32px horizontal on tablet */
      }
      .detail-media {
        grid-template-columns: 1fr;
      }
      .detail-image,
      .detail-map-container {
        height: 220px;
      }
    }
    @media (max-width: 768px) {
      .detail-subheader-inner {
        padding: var(--space-3) 0;
      }
      .detail-header-title {
        font-size: 14px;
      }
      .detail-body {
        padding-top: var(--space-4);
        margin-bottom: var(--space-4);
      }
      .detail-view-inner {
        grid-template-columns: 1fr;
        border-radius: var(--radius-md);
      }
      .detail-sidebar {
        display: none;
      }
      .detail-tabs {
        overflow-x: auto;
        padding: 0 var(--space-4);
      }
      .detail-tab {
        padding: var(--space-3) var(--space-4);
        font-size: 13px;
      }
      .detail-content {
        padding: var(--space-5) var(--space-4);  /* 20px vertical, 16px horizontal on mobile */
      }
      .detail-fields {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Zum Hauptinhalt springen</a>
  <header class="header">
    <div class="header-left">
      <div class="logo"><img src="images/ch.png" alt="Schweizer Wappen"></div>
      <div class="header-title">
        <span class="header-title-main">Bauprojekte</span>
        <span class="header-title-sub">Bundesamt für Bauten und Logistik</span>
        <span class="header-title-sub">Projektmanagement</span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-outline" onclick="openLoginDialog()">Login</button>
    </div>
  </header>

  <div class="search-section">
    <div class="search-section-inner">
      <div class="search-row">
        <div class="search-input-wrapper">
          <span class="material-icons-outlined">search</span>
          <input type="text" class="search-input" id="searchInput" placeholder="Suche mit Projektnummer, oder Bezeichnung">
        </div>
        <div class="view-toggle">
          <button class="view-btn" data-view="map" title="Karte"><span class="material-icons-outlined">map</span></button>
          <button class="view-btn" data-view="list" title="Liste"><span class="material-icons-outlined">reorder</span><span class="view-btn-label">Liste</span></button>
          <button class="view-btn active" data-view="gallery" title="Galerie"><span class="material-icons-outlined">grid_view</span></button>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-pills" id="filterPills"></div>
        <div class="filter-right">
          <div class="stats-count"><span id="objectCount">0</span> Bauprojekte</div>
          <button class="filter-btn" id="filterBtn">
            <span>Filter</span>
            <span class="filter-count" id="filterCount" style="display: none;">0</span>
            <span class="material-icons-outlined">tune</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="main" id="main">
    <div class="view-container active" id="galleryView">
      <div class="grid" id="objectGrid"></div>
    </div>

    <div class="view-container" id="listView">
      <div class="stats-boxes" id="statsBoxes">
        <div class="stats-box"><div class="stats-box-value" id="statsTotalObjects">0</div><div class="stats-box-label">Anzahl Objekte</div></div>
        <div class="stats-box stats-box-download" onclick="exportToExcel()"><span class="material-icons-outlined">download</span><div class="stats-box-label">Excel Download</div></div>
      </div>
      <div class="list-table-container">
        <table class="list-table">
          <thead><tr><th></th><th>Projektnummer</th><th>Projektbezeichnung</th><th>PLBH</th><th>Investition</th><th>Status</th></tr></thead>
          <tbody id="listTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="map-container" id="mapView">
      <div class="map-sidebar" id="mapSidebar"></div>
      <div class="map-area">
        <div id="map"></div>
      </div>
    </div>
  </main>

  <!-- Filter Modal -->
  <div class="filter-modal-overlay" id="filterModalOverlay" role="dialog" aria-modal="true" aria-labelledby="filterModalTitle">
    <div class="filter-modal">
      <div class="filter-modal-header">
        <h2 id="filterModalTitle">Suchfilter</h2>
        <div class="filter-modal-actions">
          <button class="filter-reset-btn" id="filterResetBtn" title="Filter zurücksetzen">
            <span class="material-icons-outlined">refresh</span>
          </button>
          <button class="filter-close-btn" id="filterCloseBtn">
            <span class="material-icons-outlined">close</span>
          </button>
        </div>
      </div>
      <div class="filter-modal-body">
        <div class="filter-columns" style="grid-template-columns: 1fr;">
          <div class="filter-column">
            <h3 class="filter-column-title">Status</h3>
            <div class="filter-options" id="filterStatus"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Carousel -->
  <div class="carousel-overlay" id="carouselOverlay" role="dialog" aria-modal="true" aria-label="Bildergalerie">
    <div class="carousel-header">
      <span class="carousel-counter" id="carouselCounter" aria-live="polite">1 / 5</span>
      <button class="carousel-close-btn" onclick="closeCarousel()" title="Schliessen (Esc)">
        <span class="material-icons-outlined">close</span>
      </button>
    </div>
    <div class="carousel-main" onclick="if(event.target === this) closeCarousel()">
      <button class="carousel-nav-btn prev" onclick="navigateCarousel(-1)" title="Vorheriges Bild">
        <span class="material-icons-outlined">chevron_left</span>
      </button>
      <div class="carousel-image-container">
        <img class="carousel-image" id="carouselImage" src="" alt="Bild">
      </div>
      <button class="carousel-nav-btn next" onclick="navigateCarousel(1)" title="Nächstes Bild">
        <span class="material-icons-outlined">chevron_right</span>
      </button>
    </div>
    <div class="carousel-thumbnails" id="carouselThumbnails"></div>
  </div>

  <!-- Login Dialog -->
  <div class="login-dialog-overlay" id="loginDialogOverlay" role="dialog" aria-modal="true" aria-labelledby="loginDialogTitle" onclick="if(event.target === this) closeLoginDialog()">
    <div class="login-dialog">
      <div class="login-dialog-header">
        <h3 class="login-dialog-title" id="loginDialogTitle">Anmelden</h3>
        <button class="login-dialog-close" onclick="closeLoginDialog()" aria-label="Schliessen">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>

      <div class="login-form">
        <div class="login-field">
          <label class="login-label" for="loginEmail">E-Mail</label>
          <input type="email" class="login-input" id="loginEmail" placeholder="name@beispiel.ch">
        </div>

        <div class="login-field">
          <label class="login-label" for="loginPassword">Passwort</label>
          <input type="password" class="login-input" id="loginPassword" placeholder="Passwort eingeben">
        </div>
      </div>

      <div class="login-links">
        <a class="login-link" onclick="alert('Funktion noch nicht verfügbar')">Kennwort vergessen?</a>
        <a class="login-link" onclick="alert('Funktion noch nicht verfügbar')">Neu registrieren</a>
      </div>

      <div class="login-actions">
        <button class="login-btn-cancel" onclick="closeLoginDialog()">Abbrechen</button>
        <button class="login-btn-submit" onclick="submitLogin()">Anmelden</button>
      </div>
    </div>
  </div>

  <!-- Detail View -->
  <div class="detail-view" id="detailView">
    <!-- Sub-Header (full-width) -->
    <div class="detail-subheader">
      <div class="detail-subheader-inner">
        <span class="material-icons-outlined detail-header-icon">apartment</span>
        <h1 class="detail-header-title" id="detailHeaderTitle">-</h1>
        <button class="detail-edit-btn" onclick="alert('Bearbeiten-Funktion noch nicht verfügbar')">
          <span class="material-icons-outlined">lock</span>
          Bearbeiten
        </button>
        <button class="detail-back-btn" onclick="closeDetailView()">
          <span class="material-icons-outlined">arrow_back</span>
          Zurück zur Übersicht
        </button>
      </div>
    </div>

    <!-- Body with whitespace above -->
    <div class="detail-body">
      <div class="detail-view-inner">
        <div class="detail-sidebar">
          <div class="detail-sidebar-header">
            Bauprojekte (<span id="detailProjectCount">0</span>)
          </div>
          <div class="detail-sidebar-list" id="detailSidebarList">
            <!-- Project list items will be rendered here -->
          </div>
        </div>
        <div class="detail-main">
          <div class="detail-tabs">
            <button class="detail-tab active" data-tab="uebersicht">Übersicht</button>
            <button class="detail-tab" data-tab="projektziele">Projektziele</button>
            <button class="detail-tab" data-tab="risiken">Risiken</button>
            <button class="detail-tab" data-tab="kennzahlen">Grundgrössen und Kennzahlen</button>
            <button class="detail-tab" data-tab="checkliste" disabled>Checkliste Lieferobjekte</button>
          </div>
          <div class="detail-content" id="detailContent">
            <!-- Tab content will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <a href="https://github.com/davras5/pm-cockpit" class="footer-link" target="_blank" rel="noopener noreferrer">Quellcode</a>
    <a href="https://www.admin.ch/gov/de/start/rechtliches.html" class="footer-link" target="_blank" rel="noopener noreferrer">Rechtliches</a>
  </footer>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRyYXNuZXI1IiwiYSI6ImNtMm5yamVkdjA5MDcycXMyZ2I2MHRhamgifQ.m651j7WIX7MyxNh8KIQ1Gg';

    let properties = [];
    let filteredProperties = [];
    let dataReferences = {};
    let searchQuery = '';
    let currentView = 'gallery';
    let map = null;
    let mapLoaded = false;
    let markers = [];
    let markersMap = new Map();

    // Advanced filter state - simplified to only status
    let advancedFilters = {
      status: new Set()       // Status filter
    };

    // Unique values from data (populated after load)
    let filterOptions = {
      status: []
    };

    // Carousel state
    let carouselImages = [];
    let carouselIndex = 0;

    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        view: params.get('view'),
        id: params.get('id'),
        q: params.get('q'),
        status: params.get('status'),
        tab: params.get('tab')
      };
    }

    function updateUrlParams() {
      const params = new URLSearchParams();

      // Add project ID if in detail view
      if (currentDetailProjectId) {
        params.set('id', currentDetailProjectId);
        if (currentDetailTab && currentDetailTab !== 'uebersicht') {
          params.set('tab', currentDetailTab);
        }
      } else {
        if (currentView !== 'gallery') params.set('view', currentView);
        if (searchQuery) params.set('q', searchQuery);

        // Add status filter if active
        if (advancedFilters.status.size > 0) {
          params.set('status', Array.from(advancedFilters.status).join(','));
        }
      }

      const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
      window.history.replaceState({}, '', newUrl);
    }

    function loadFiltersFromUrl() {
      const params = getUrlParams();
      if (params.view && ['gallery', 'list', 'map'].includes(params.view)) currentView = params.view;
      if (params.q) {
        searchQuery = params.q;
        document.getElementById('searchInput').value = searchQuery;
      }

      // Load status filter from URL
      if (params.status) {
        params.status.split(',').forEach(val => advancedFilters.status.add(val));
      }
    }

    // Status helper functions
    function getStatusClass(status) {
      if (!status) return 'status-unknown';
      const classMap = {
        'planned': 'status-pending',
        'active': 'status-active',
        'on_hold': 'status-inactive',
        'completed': 'status-sold',
        'cancelled': 'status-unknown'
      };
      return classMap[status.toLowerCase()] || 'status-unknown';
    }
    function getStatusLabel(status) {
      if (!status) return 'Unbekannt';
      const labels = {
        'planned': 'Geplant',
        'active': 'Aktiv',
        'on_hold': 'Sistiert',
        'completed': 'Abgeschlossen',
        'cancelled': 'Abgebrochen'
      };
      return labels[status.toLowerCase()] || status;
    }
    function getMarkerClass(status) {
      if (!status) return 'marker-unknown';
      const classMap = {
        'planned': 'marker-pending',
        'active': 'marker-active',
        'on_hold': 'marker-inactive',
        'completed': 'marker-sold',
        'cancelled': 'marker-unknown'
      };
      return classMap[status.toLowerCase()] || 'marker-unknown';
    }

    // Currency formatting helper
    function formatCurrency(value) {
      if (value === null || value === undefined) return '-';
      return 'CHF ' + new Intl.NumberFormat('de-CH').format(value);
    }

    // SubPortfolio label helper
    function getSubPortfolioLabel(subPortfolio, references) {
      if (!subPortfolio || !references?.subPortfolio) return '-';
      const ref = references.subPortfolio.find(r => r.id === subPortfolio);
      return ref ? ref.label : subPortfolio;
    }

    // Format full address from new fields
    function formatAddress(prop) {
      const parts = [];
      if (prop.street) {
        parts.push(prop.street + (prop.streetnumber ? ' ' + prop.streetnumber : ''));
      }
      if (prop.zip || prop.city) {
        parts.push([prop.zip, prop.city].filter(Boolean).join(' '));
      }
      return parts.join(', ') || 'Keine Adresse';
    }

    function getPlaceholderImage(type, id) {
      const idStr = String(id);
      const hash = idStr.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const imageIndex = Math.abs(hash) % 5;
      const images = ['https://images.unsplash.com/photo-1504307651254-35680f356dfd', 'https://images.unsplash.com/photo-1541888946425-d81bb19240f5', 'https://images.unsplash.com/photo-1503387762-592deb58ef4e', 'https://images.unsplash.com/photo-1581094288338-2314dddb7ece', 'https://images.unsplash.com/photo-1590644365607-1c5a1a5d0c3e'];
      return images[imageIndex] + '?w=400&h=300&fit=crop';
    }

    // Extract unique filter options from data
    function extractFilterOptions() {
      const statuses = new Set();

      properties.forEach(prop => {
        if (prop.status) statuses.add(prop.status);
      });

      filterOptions.status = Array.from(statuses).sort();
    }

    // Check if any filters are active
    function hasActiveFilters() {
      return advancedFilters.status.size > 0 || searchQuery;
    }

    // Count total active filters (excluding search)
    function getActiveFilterCount() {
      return advancedFilters.status.size;
    }

    // Get status counts from all properties
    function getStatusCounts() {
      const counts = {};
      properties.forEach(prop => {
        const status = prop.status || 'unknown';
        counts[status] = (counts[status] || 0) + 1;
      });
      return counts;
    }

    // Update the filter button appearance and count
    function updateFilterButtonState() {
      const btn = document.getElementById('filterBtn');
      const countEl = document.getElementById('filterCount');
      const count = getActiveFilterCount();

      if (count > 0) {
        btn.classList.add('has-filters');
        countEl.textContent = count;
        countEl.style.display = 'inline';
      } else {
        btn.classList.remove('has-filters');
        countEl.style.display = 'none';
      }
    }

    // Render status pills and reset button
    function renderStatusPills() {
      const container = document.getElementById('filterPills');
      const counts = getStatusCounts();

      // Build pills HTML for each status
      let html = filterOptions.status.map(status => {
        const isActive = advancedFilters.status.has(status);
        const count = counts[status] || 0;
        return `
          <button class="filter-pill ${isActive ? 'active' : ''}" data-status="${status}">
            ${getStatusLabel(status)} (${count})
            <span class="material-icons-outlined close-icon">close</span>
          </button>
        `;
      }).join('');

      // Add reset button
      html += `
        <button class="reset-filters ${hasActiveFilters() ? 'visible' : ''}" id="resetFilters" title="Alle Filter zurücksetzen">
          <span class="material-icons-outlined">replay</span>
        </button>
      `;

      container.innerHTML = html;

      // Add click handlers for status pills
      container.querySelectorAll('.filter-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          const status = pill.dataset.status;
          if (advancedFilters.status.has(status)) {
            advancedFilters.status.delete(status);
          } else {
            advancedFilters.status.add(status);
          }
          applyFilters();
          renderFilterModal();
        });
      });

      // Add click handler for reset button
      const resetBtn = container.querySelector('#resetFilters');
      if (resetBtn) {
        resetBtn.addEventListener('click', resetAllFilters);
      }
    }

    // Reset all filters
    function resetAllFilters() {
      Object.keys(advancedFilters).forEach(key => advancedFilters[key].clear());
      searchQuery = '';
      document.getElementById('searchInput').value = '';
      applyFilters();
      if (document.getElementById('filterModalOverlay').classList.contains('active')) {
        renderFilterModal();
      }
    }

    // Apply all filters
    function applyFilters() {
      filteredProperties = properties.filter(prop => {
        // Search query filter - search across project number, project name, city, region
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          const searchFields = [prop.projectNumber, prop.projectName, prop.city, prop.region, prop.projectManager].map(f => (f || '').toString().toLowerCase());
          if (!searchFields.some(field => field.includes(query))) return false;
        }

        // Status filter
        if (advancedFilters.status.size > 0 && !advancedFilters.status.has(prop.status)) {
          return false;
        }

        return true;
      });

      if (currentView === 'gallery') renderCards();
      else if (currentView === 'list') renderListView();
      else if (currentView === 'map') renderMapView();

      updateUrlParams();
      updateFilterButtonState();
      renderStatusPills();
    }

    // Render filter modal options
    function renderFilterModal() {
      // Helper to create option HTML with close icon
      const createOption = (isSelected, filterKey, value, label) => `
        <div class="filter-option ${isSelected ? 'selected' : ''}" data-filter="${filterKey}" data-value="${value}">
          <span>${label}</span>
          <span class="material-icons-outlined close-icon">close</span>
        </div>
      `;

      // Status filter
      const statusContainer = document.getElementById('filterStatus');
      if (statusContainer) {
        statusContainer.innerHTML = filterOptions.status.map(s =>
          createOption(advancedFilters.status.has(s), 'status', s, getStatusLabel(s))
        ).join('');
      }

      // Add click handlers
      document.querySelectorAll('.filter-modal .filter-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const filterKey = opt.dataset.filter;
          const filterValue = opt.dataset.value;

          if (advancedFilters[filterKey].has(filterValue)) {
            advancedFilters[filterKey].delete(filterValue);
            opt.classList.remove('selected');
          } else {
            advancedFilters[filterKey].add(filterValue);
            opt.classList.add('selected');
          }

          applyFilters();
          // Update close icons visibility
          renderFilterModal();
        });
      });
    }

    // Filter Modal open/close
    function openFilterModal() {
      renderFilterModal();
      document.getElementById('filterModalOverlay').classList.add('active');
      document.getElementById('filterBtn').classList.add('panel-open');
      document.body.style.overflow = 'hidden';
    }

    function closeFilterModal() {
      document.getElementById('filterModalOverlay').classList.remove('active');
      document.getElementById('filterBtn').classList.remove('panel-open');
      document.body.style.overflow = '';
    }

    // --- Image Carousel Functions ---
    function openCarousel(images, startIndex = 0) {
      carouselImages = images;
      carouselIndex = startIndex;
      updateCarouselView();
      document.getElementById('carouselOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCarousel() {
      document.getElementById('carouselOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    function navigateCarousel(direction) {
      const newIndex = carouselIndex + direction;
      if (newIndex >= 0 && newIndex < carouselImages.length) {
        carouselIndex = newIndex;
        updateCarouselView();
      }
    }

    function goToCarouselImage(index) {
      if (index >= 0 && index < carouselImages.length) {
        carouselIndex = index;
        updateCarouselView();
      }
    }

    function updateCarouselView() {
      // Update counter
      document.getElementById('carouselCounter').textContent = `${carouselIndex + 1} / ${carouselImages.length}`;

      // Update main image with higher resolution
      const currentImage = carouselImages[carouselIndex].replace('w=400&h=300', 'w=1200&h=900');
      document.getElementById('carouselImage').src = currentImage;

      // Update navigation buttons
      document.querySelector('.carousel-nav-btn.prev').disabled = carouselIndex === 0;
      document.querySelector('.carousel-nav-btn.next').disabled = carouselIndex === carouselImages.length - 1;

      // Update thumbnails
      const thumbsContainer = document.getElementById('carouselThumbnails');
      thumbsContainer.innerHTML = carouselImages.map((img, idx) => `
        <div class="carousel-thumb ${idx === carouselIndex ? 'active' : ''}"
             style="background-image: url('${img}')"
             onclick="goToCarouselImage(${idx})"></div>
      `).join('');
    }

    function getDataToRender() { return (filteredProperties.length > 0 || hasActiveFilters()) ? filteredProperties : properties; }

    function renderCards() {
      const grid = document.getElementById('objectGrid');
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      grid.innerHTML = data.map(prop => `
        <div class="card" data-id="${prop.id}">
          <div class="card-image" style="background-image: url('${getPlaceholderImage(prop.projectName, prop.id)}')">
          </div>
          <div class="card-content">
            <div class="card-label">${prop.projectNumber || '-'}</div>
            <div class="card-location">${prop.projectName || '-'}</div>
            <div class="card-details">
              <span class="card-detail-label">Projektziele:</span><span class="card-detail-value">-</span>
              <span class="card-detail-label">Risiken:</span><span class="card-detail-value">-</span>
            </div>
            <div class="card-details" style="border-top: 1px solid var(--neutral-200); padding-top: var(--space-3);">
              <span class="card-detail-label">Status:</span><span class="card-detail-value">${getStatusLabel(prop.status)}</span>
              <span class="card-detail-label">Teilportfolio:</span><span class="card-detail-value">${getSubPortfolioLabel(prop.subPortfolio, dataReferences)}</span>
              <span class="card-detail-label">PLBH:</span><span class="card-detail-value">${prop.projectManager || '-'}</span>
              <span class="card-detail-label">Investition:</span><span class="card-detail-value">${formatCurrency(prop.plannedTotalCost)}</span>
              <span class="card-detail-label">Letzte Änderung:</span><span class="card-detail-value">${prop.lastModified || '-'}</span>
            </div>
          </div>
        </div>`).join('');
    }

    function renderListView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;

      // Update stats
      document.getElementById('statsTotalObjects').textContent = data.length;

      const tbody = document.getElementById('listTableBody');
      tbody.innerHTML = data.map(prop => `
        <tr data-id="${prop.id}">
          <td><span class="material-icons-outlined object-icon">domain</span></td>
          <td>${prop.projectNumber || '-'}</td>
          <td>${prop.projectName || '-'}</td>
          <td>${prop.projectManager || '-'}</td>
          <td>${formatCurrency(prop.plannedTotalCost)}</td>
          <td><span class="status-tag ${getStatusClass(prop.status)}" data-filter="status" data-value="${prop.status}">${getStatusLabel(prop.status)}</span></td>
        </tr>`).join('');
    }

    // --- SIDEBAR RENDER FUNCTION ---
    function renderMapView() {
      const data = getDataToRender();
      document.getElementById('objectCount').textContent = data.length;
      const sidebar = document.getElementById('mapSidebar');

      // Simplified structure with status tag
      sidebar.innerHTML = data.map(prop => `
        <div class="map-sidebar-item" data-id="${prop.id}">
          <div class="map-sidebar-image" style="background-image: url('${getPlaceholderImage(prop.projectName, prop.id)}')">
            <div class="image-tags">
              <span class="status-tag ${getStatusClass(prop.status)}" data-filter="status" data-value="${prop.status}">${getStatusLabel(prop.status)}</span>
            </div>
          </div>
          <div class="map-sidebar-content">
            <div class="map-sidebar-title">${prop.projectNumber || '-'}</div>
            <div class="map-sidebar-price">${prop.projectName || '-'}</div>
          </div>
        </div>`).join('');

      if (!map) {
        initializeMap();
      } else if (mapLoaded) {
        updateMapMarkers(data);
      }
      // Wenn map existiert aber noch nicht geladen ist,
      // werden die Marker automatisch beim 'load'-Event aktualisiert
    }

    function flyToProperty(id) {
      const prop = properties.find(p => p.id === id);
      if (!prop || !prop.lat || !prop.lng) return;
      document.querySelectorAll('.map-sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.id === id) item.classList.add('active');
      });
      document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
      const md = markersMap.get(id);
      if (md) {
        md.marker.getElement().classList.add('selected');
        map.flyTo({ center: [prop.lng, prop.lat], zoom: 13, duration: 1500 });
        setTimeout(() => {
          const popup = md.marker.getPopup();
          if (popup && !popup.isOpen()) {
            md.marker.togglePopup();
          }
        }, 1600);
      }
    }

    function initializeMap() {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [8.2275, 46.8182], zoom: 7
      });
      map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      map.on('load', () => {
        mapLoaded = true;
        updateMapMarkers(getDataToRender());
      });
    }

    function updateMapMarkers(data) {
      markers.forEach(marker => marker.remove());
      markers = []; markersMap.clear();
      const bounds = new mapboxgl.LngLatBounds();
      data.forEach(prop => {
        if (prop.lat && prop.lng) {
          const el = document.createElement('div');
          el.className = `marker ${getMarkerClass(prop.status)}`;
          el.innerHTML = '<span class="material-icons-outlined">home</span>';
          el.addEventListener('click', () => {
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            el.classList.add('selected');
            flyToProperty(prop.id);
          });

          const popup = new mapboxgl.Popup({ offset: 25, maxWidth: '280px' }).setHTML(`
            <div class="popup-image" style="background-image: url('${getPlaceholderImage(prop.projectName, prop.id)}')"></div>
            <div class="popup-content">
              <div class="popup-title">${prop.projectNumber || '-'}</div>
              <div class="popup-location">${prop.projectName || '-'}</div>
              <div class="popup-status">${getStatusLabel(prop.status)}</div>
              <a class="popup-link" data-id="${prop.id}">Details anzeigen</a>
            </div>`);

          const marker = new mapboxgl.Marker(el).setLngLat([prop.lng, prop.lat]).setPopup(popup).addTo(map);
          markers.push(marker);
          markersMap.set(prop.id, { marker, prop });
          bounds.extend([prop.lng, prop.lat]);
        }
      });
      if (markers.length > 0) map.fitBounds(bounds, { padding: 80, maxZoom: 10 });
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        const label = btn.querySelector('.view-btn-label');
        if (label) label.remove();
      });
      const activeBtn = document.querySelector(`.view-btn[data-view="${view}"]`);
      if (activeBtn) {
        activeBtn.classList.add('active');
        const label = document.createElement('span');
        label.className = 'view-btn-label';
        label.textContent = { gallery: 'Galerie', list: 'Liste', map: 'Karte' }[view];
        activeBtn.appendChild(label);
      }

      document.getElementById('galleryView').classList.remove('active');
      document.getElementById('listView').classList.remove('active');
      document.getElementById('mapView').classList.remove('active');

      if (view === 'gallery') {
        document.getElementById('galleryView').classList.add('active');
        renderCards();
      } else if (view === 'list') {
        document.getElementById('listView').classList.add('active');
        renderListView();
      } else if (view === 'map') {
        document.getElementById('mapView').classList.add('active');
        renderMapView();
        setTimeout(() => { if (map) map.resize(); }, 150);
      }
      updateUrlParams();
    }

    function setupViewToggle() {
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          if (view) setView(view);
        });
      });
    }

    function exportToExcel() { alert('Excel Export Placeholder'); }

    function setupFilterModal() {
      // Open filter modal
      document.getElementById('filterBtn').addEventListener('click', openFilterModal);

      // Close filter modal
      document.getElementById('filterCloseBtn').addEventListener('click', closeFilterModal);
      document.getElementById('filterModalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeFilterModal();
      });

      // Reset filters button in modal
      document.getElementById('filterResetBtn').addEventListener('click', () => {
        resetAllFilters();
      });

      // Keyboard navigation (handles carousel, filter modal, and detail view)
      document.addEventListener('keydown', (e) => {
        const carouselActive = document.getElementById('carouselOverlay').classList.contains('active');

        // Carousel keyboard controls
        if (carouselActive) {
          if (e.key === 'Escape') {
            closeCarousel();
          } else if (e.key === 'ArrowLeft') {
            navigateCarousel(-1);
          } else if (e.key === 'ArrowRight') {
            navigateCarousel(1);
          }
          return;
        }

        // Other Escape handlers
        if (e.key === 'Escape') {
          // Close detail view first if open
          if (document.getElementById('detailView').classList.contains('active')) {
            closeDetailView();
            return;
          }
          if (document.getElementById('filterModalOverlay').classList.contains('active')) {
            closeFilterModal();
          }
        }
      });
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      let debounceTimer;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          searchQuery = e.target.value.trim();
          applyFilters();
        }, 300);
      });
    }

    // Canton code mapping for SVG highlighting (Wikipedia SVG uses canton codes directly)
    const cantonCodeMap = {
      'AG': 'AG', 'AI': 'AI', 'AR': 'AR', 'BE': 'BE', 'BL': 'BL',
      'BS': 'BS', 'FR': 'FR', 'GE': 'GE', 'GL': 'GL', 'GR': 'GR',
      'JU': 'JU', 'LU': 'LU', 'NE': 'NE', 'NW': 'NW', 'OW': 'OW',
      'SG': 'SG', 'SH': 'SH', 'SO': 'SO', 'SZ': 'SZ', 'TG': 'TG',
      'TI': 'TI', 'UR': 'UR', 'VD': 'VD', 'VS': 'VS', 'ZG': 'ZG', 'ZH': 'ZH'
    };

    // Open login dialog
    function openLoginDialog() {
      const overlay = document.getElementById('loginDialogOverlay');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Clear form
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // Close login dialog
    function closeLoginDialog() {
      const overlay = document.getElementById('loginDialogOverlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Submit login (mockup - just closes dialog)
    function submitLogin() {
      closeLoginDialog();
    }

    // --- Detail View State ---
    let detailMap = null;
    let detailMapLoaded = false;
    let currentDetailProjectId = null;
    let currentDetailTab = 'uebersicht';
    let previousView = 'gallery';

    // Get SIA phase label (just the number like "32")
    function getSiaPhaseNumber(siaPhase) {
      if (!siaPhase) return '-';
      // Extract just the number from 'sia_32' -> '32'
      const match = siaPhase.match(/sia_(\d+)/);
      return match ? match[1] : siaPhase;
    }

    // Get management area label
    function getManagementAreaLabel(areaId) {
      if (!areaId || !dataReferences?.managementAreas) return '-';
      const ref = dataReferences.managementAreas.find(r => r.id === areaId);
      return ref ? ref.label : '-';
    }

    // Get construction type label
    function getConstructionTypeLabel(typeId) {
      if (!typeId || !dataReferences?.constructionTypes) return '-';
      const ref = dataReferences.constructionTypes.find(r => r.id === typeId);
      return ref ? ref.label : '-';
    }

    // Get SIA phase full label
    function getSiaPhaseLabel(siaPhase) {
      if (!siaPhase || !dataReferences?.siaPhases) return '-';
      const ref = dataReferences.siaPhases.find(r => r.id === siaPhase);
      return ref ? ref.label : '-';
    }

    // Get building status label
    function getBuildingStatusLabel(statusId) {
      if (!statusId || !dataReferences?.buildingStatus) return '-';
      const ref = dataReferences.buildingStatus.find(r => r.id === statusId);
      return ref ? ref.label : '-';
    }

    // Get country label
    function getCountryLabel(countryId) {
      if (!countryId || !dataReferences?.countries) return '-';
      const ref = dataReferences.countries.find(r => r.id === countryId);
      return ref ? ref.label : '-';
    }

    // Open detail view
    function openDetailView(projectId, skipHistory = false) {
      const project = properties.find(p => p.id === projectId);
      if (!project) return;

      currentDetailProjectId = projectId;
      previousView = currentView;

      // Get tab from URL or use current tab
      const urlParams = getUrlParams();
      const tabToShow = urlParams.tab || currentDetailTab || 'uebersicht';

      // Render sidebar with all projects
      renderDetailSidebar();

      // Show detail view
      document.getElementById('detailView').classList.add('active');
      document.querySelector('.search-section').style.display = 'none';
      document.getElementById('main').style.display = 'none';

      // Render the appropriate tab content
      switchDetailTab(tabToShow);

      // Update URL with pushState for browser navigation
      if (!skipHistory) {
        const params = new URLSearchParams();
        params.set('id', projectId);
        if (tabToShow !== 'uebersicht') {
          params.set('tab', tabToShow);
        }
        window.history.pushState({ projectId, tab: tabToShow }, '', `${window.location.pathname}?${params.toString()}`);
      }

      // Initialize or update detail map if on uebersicht tab
      if (tabToShow === 'uebersicht') {
        setTimeout(() => {
          initializeDetailMap(project);
        }, 100);
      }
    }

    // Close detail view
    function closeDetailView(skipHistory = false) {
      currentDetailProjectId = null;
      document.getElementById('detailView').classList.remove('active');
      document.querySelector('.search-section').style.display = '';
      document.getElementById('main').style.display = '';

      // Clean up detail map
      if (detailMap) {
        detailMap.remove();
        detailMap = null;
        detailMapLoaded = false;
      }

      // Update URL with pushState for browser navigation
      if (!skipHistory) {
        const params = new URLSearchParams();
        if (currentView !== 'gallery') params.set('view', currentView);
        if (searchQuery) params.set('q', searchQuery);
        if (advancedFilters.status.size > 0) {
          params.set('status', Array.from(advancedFilters.status).join(','));
        }
        const newUrl = params.toString() ? `${window.location.pathname}?${params.toString()}` : window.location.pathname;
        window.history.pushState({}, '', newUrl);
      }
    }

    // Render detail sidebar with project list
    function renderDetailSidebar() {
      const data = getDataToRender();
      const container = document.getElementById('detailSidebarList');
      document.getElementById('detailProjectCount').textContent = data.length;

      container.innerHTML = data.map(prop => `
        <div class="detail-sidebar-item ${prop.id === currentDetailProjectId ? 'active' : ''}" data-detail-id="${prop.id}">
          <span class="material-icons-outlined">apartment</span>
          <span class="detail-sidebar-item-text">${prop.projectNumber || '-'}</span>
        </div>
      `).join('');

      // Add click handlers
      container.querySelectorAll('.detail-sidebar-item').forEach(item => {
        item.addEventListener('click', () => {
          const id = item.dataset.detailId;
          if (id && id !== currentDetailProjectId) {
            openDetailView(id);
          }
        });
      });

      // Scroll to active item
      const activeItem = container.querySelector('.detail-sidebar-item.active');
      if (activeItem) {
        activeItem.scrollIntoView({ block: 'nearest' });
      }
    }

    // Render detail content (Übersicht tab)
    function renderDetailContent(project) {
      // Update header
      const title = `${project.projectNumber || '-'} - ${project.city || ''} ${project.region || ''}, ${project.projectName || '-'}`;
      document.getElementById('detailHeaderTitle').textContent = title;

      // Get building data
      const building = project.building;

      // Render building section (unified components)
      const renderBuildingSection = () => {
        if (!building) {
          return `
            <div class="tab-section">
              <div class="tab-section-header">Gebäude</div>
              <div class="detail-info-message">
                <span class="material-icons-outlined">info</span>
                <span>Kein Gebäude gefunden</span>
              </div>
            </div>
          `;
        }

        // Format full address
        const addressLine = [building.street, building.streetNumber].filter(Boolean).join(' ') || '-';
        const cityLine = [building.zip, building.city].filter(Boolean).join(' ') || '-';

        return `
          <div class="tab-section">
            <div class="tab-section-header">Gebäude</div>
            <div class="detail-fields">
              <div class="detail-field">
                <span class="detail-field-label">Bezeichnung</span>
                <span class="detail-field-value">${building.designation || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Gebäudenummer</span>
                <span class="detail-field-value">${building.buildingNumber || '-'}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">EGID</span>
                <span class="detail-field-value">${building.egid || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Grundstücknummer</span>
                <span class="detail-field-value">${building.plotNumber || '-'}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Gebäudestatus</span>
                <span class="detail-field-value">${getBuildingStatusLabel(building.buildingStatus)}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Subportfolio</span>
                <span class="detail-field-value">${getSubPortfolioLabel(building.subPortfolio, dataReferences)}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Adresse</span>
                <span class="detail-field-value">${addressLine}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">PLZ / Ort</span>
                <span class="detail-field-value">${cityLine}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Region/Kanton</span>
                <span class="detail-field-value">${building.region || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Land</span>
                <span class="detail-field-value">${getCountryLabel(building.country)}</span>
              </div>
            </div>
          </div>
        `;
      };

      // Render content (unified components)
      const content = document.getElementById('detailContent');
      content.innerHTML = `
        <h2 class="tab-header">Übersicht</h2>
        <div class="tab-container">
          <div class="detail-media">
            <div class="detail-image" style="background-image: url('${getPlaceholderImage(project.projectName, project.id)}')"></div>
            <div class="detail-map-container">
              <div id="detailMap"></div>
            </div>
          </div>

          <div class="tab-section">
            <div class="tab-section-header">Bauprojekt</div>
            <div class="detail-fields">
              <div class="detail-field">
                <span class="detail-field-label">Projektbezeichnung</span>
                <span class="detail-field-value">${project.projectName || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">SIA Phase</span>
                <span class="detail-field-value">${getSiaPhaseNumber(project.siaPhase)}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Projektnummer</span>
                <span class="detail-field-value highlight">${project.projectNumber || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Projektstart</span>
                <span class="detail-field-value">${project.projectStart || '-'}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Bewirtschaftungsgebiet</span>
                <span class="detail-field-value">${getManagementAreaLabel(project.managementArea)}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Bauart</span>
                <span class="detail-field-value">${getConstructionTypeLabel(project.constructionType)}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Projektstatus</span>
                <span class="detail-field-value">${getStatusLabel(project.status)}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Geplante Gesamtkosten</span>
                <span class="detail-field-value">${formatCurrency(project.plannedTotalCost)}</span>
              </div>

              <div class="detail-field">
                <span class="detail-field-label">Projektleiter BBL</span>
                <span class="detail-field-value">${project.projectManager || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Letzte Änderung</span>
                <span class="detail-field-value">${project.lastModified || '-'}</span>
              </div>
            </div>
          </div>

          ${renderBuildingSection()}
        </div>
      `;
    }

    // Initialize detail map
    function initializeDetailMap(project) {
      const container = document.getElementById('detailMap');
      if (!container) return;

      // Remove existing map if any
      if (detailMap) {
        detailMap.remove();
        detailMap = null;
      }

      // Check if we have coordinates
      if (!project.lat || !project.lng) {
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--neutral-500);">Keine Standortdaten verfügbar</div>';
        return;
      }

      detailMap = new mapboxgl.Map({
        container: 'detailMap',
        style: 'mapbox://styles/mapbox/light-v11',
        center: [project.lng, project.lat],
        zoom: 15,
        interactive: true
      });

      detailMap.addControl(new mapboxgl.NavigationControl(), 'top-right');

      detailMap.on('load', () => {
        detailMapLoaded = true;

        // Add marker
        const el = document.createElement('div');
        el.className = `marker ${getMarkerClass(project.status)}`;
        el.innerHTML = '<span class="material-icons-outlined">location_on</span>';

        new mapboxgl.Marker(el)
          .setLngLat([project.lng, project.lat])
          .addTo(detailMap);
      });
    }

    // Format number with thousands separator (Swiss format)
    function formatNumber(value, decimals = 0) {
      if (value === null || value === undefined) return '-';
      return new Intl.NumberFormat('de-CH', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      }).format(value);
    }

    // Format percentage
    function formatPercent(value) {
      if (value === null || value === undefined) return '-';
      return (value * 100).toFixed(1) + '%';
    }

    // Render BKP Cost section
    function renderKostenBkpSection(project) {
      const kostenBkp = project.kostenBkp || {};
      const g = project.grundgroessen || {};
      const gsf = g.grundstueckflaechen || {};
      const gfl = g.gebaeudeflaechen || {};
      const gv = g.gebaeudevolumen || {};

      // Reference values
      const gsfValue = gsf.gsf;
      const gfValue = gfl.gf;
      const nfValue = gfl.nf;
      const gvValue = gv.gv;

      // BKP row definitions (hardcoded)
      const bkpRows = [
        { code: 0, name: 'Grundstück', bezugType: 'GSF', bezugValue: gsfValue },
        { code: 1, name: 'Vorbereitung', bezugType: '-', bezugValue: null },
        { code: 2, name: 'Gebäude', bezugType: 'GF', bezugValue: gfValue },
        { code: 3, name: 'Betriebseinrichtungen', bezugType: '-', bezugValue: null },
        { code: 4, name: 'Umgebung', bezugType: '-', bezugValue: null },
        { code: 5, name: 'Baunebenkosten', bezugType: '-', bezugValue: null },
        { code: 6, name: 'Reserve', bezugType: '-', bezugValue: null },
        { code: 7, name: 'Reserve', bezugType: '-', bezugValue: null },
        { code: 8, name: 'Honorar / Risiko', bezugType: '-', bezugValue: null },
        { code: 9, name: 'Ausstattung', bezugType: 'NF', bezugValue: nfValue }
      ];

      // Get costs for each BKP
      const getCosts = (code) => {
        const key = `bkp${code}`;
        return kostenBkp[key] || { kennwert: 0, chfKosten: 0 };
      };

      // Calculate sum of BKP 1-6
      const sumBkp16 = [1, 2, 3, 4, 5, 6].reduce((sum, code) => sum + (getCosts(code).chfKosten || 0), 0);

      // Calculate sum of BKP 1-9
      const sumBkp19 = [1, 2, 3, 4, 5, 6, 7, 8, 9].reduce((sum, code) => sum + (getCosts(code).chfKosten || 0), 0);

      // Calculate total (0-9)
      const sumTotal = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9].reduce((sum, code) => sum + (getCosts(code).chfKosten || 0), 0);

      // Helper to calculate percentage of BKP 1-6
      const calcPercentBkp16 = (chfKosten) => {
        if (!chfKosten || !sumBkp16) return '-';
        return ((chfKosten / sumBkp16) * 100).toFixed(1) + '%';
      };

      // Helper to calculate CHF/m³ GV
      const calcChfPerGV = (chfKosten) => {
        if (!chfKosten || !gvValue) return '-';
        return formatNumber(Math.round(chfKosten / gvValue));
      };

      // Helper to calculate CHF/m² GF
      const calcChfPerGF = (chfKosten) => {
        if (!chfKosten || !gfValue) return '-';
        return formatNumber(Math.round(chfKosten / gfValue));
      };

      // Render a single BKP row
      const renderRow = (row) => {
        const costs = getCosts(row.code);
        const kennwert = costs.kennwert || 0;
        const chfKosten = costs.chfKosten || 0;
        const hasCost = chfKosten > 0;

        return `
          <tr>
            <td class="data-row__id">${row.code}</td>
            <td class="data-row__label">${row.name}</td>
            <td class="text-right ${!row.bezugValue ? 'text-muted' : ''}">${row.bezugValue ? formatNumber(row.bezugValue) : '-'}</td>
            <td class="text-muted">${row.bezugValue ? 'm²' : ''}</td>
            <td class="text-muted">${row.bezugType}</td>
            <td class="text-right ${!hasCost ? 'text-muted' : ''}">${hasCost ? formatNumber(kennwert) : '-'}</td>
            <td class="text-right ${!hasCost ? 'text-muted' : ''}">${hasCost ? formatNumber(chfKosten) : '-'}</td>
            <td class="text-right ${!hasCost ? 'text-muted' : ''}">${calcPercentBkp16(chfKosten)}</td>
            <td class="text-right ${!hasCost ? 'text-muted' : ''}">${calcChfPerGV(chfKosten)}</td>
            <td class="text-right ${!hasCost ? 'text-muted' : ''}">${calcChfPerGF(chfKosten)}</td>
          </tr>
        `;
      };

      return `
        <h2 class="tab-header">Kosten nach Hauptgruppen BKP</h2>
        <table class="bkp-table">
          <thead>
            <tr>
              <th>Code</th>
              <th></th>
              <th colspan="3">Bezugsmenge</th>
              <th style="text-align: right">Kennwert</th>
              <th style="text-align: right">CHF Kosten</th>
              <th style="text-align: right">%BKP 1 - 6</th>
              <th style="text-align: right">CHF / m³ GV</th>
              <th style="text-align: right">CHF / m² GF</th>
            </tr>
          </thead>
          <tbody>
            ${bkpRows.map(renderRow).join('')}
            <tr class="bkp-total">
              <td></td>
              <td>Total</td>
              <td colspan="3"></td>
              <td></td>
              <td class="text-right">${formatNumber(sumTotal)}</td>
              <td class="text-right">100.0%</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="bkp-spacer"><td colspan="10"></td></tr>
            <tr class="bkp-summary">
              <td class="data-row__id">1 - 6</td>
              <td>Herstellungskosten</td>
              <td colspan="3"></td>
              <td></td>
              <td class="text-right">${formatNumber(sumBkp16)}</td>
              <td></td>
              <td class="text-right">${gvValue ? formatNumber(Math.round(sumBkp16 / gvValue)) : '-'}</td>
              <td class="text-right">${gfValue ? formatNumber(Math.round(sumBkp16 / gfValue)) : '-'}</td>
            </tr>
            <tr class="bkp-summary">
              <td class="data-row__id">1 - 9</td>
              <td>Anlagekosten</td>
              <td colspan="3"></td>
              <td></td>
              <td class="text-right">${formatNumber(sumBkp19)}</td>
              <td></td>
              <td class="text-right">${gvValue ? formatNumber(Math.round(sumBkp19 / gvValue)) : '-'}</td>
              <td class="text-right">${gfValue ? formatNumber(Math.round(sumBkp19 / gfValue)) : '-'}</td>
            </tr>
          </tbody>
        </table>
      `;
    }

    // Render Kennzahlen content (Grundgrössen und Kennzahlen tab)
    function renderKennzahlenContent(project) {
      const content = document.getElementById('detailContent');
      const g = project.grundgroessen || {};

      // Calculate percentage relative to base value
      const calcPercent = (value, base, label) => {
        if (value === null || value === undefined || !base) return '-';
        const pct = ((value / base) * 100).toFixed(0);
        return `${pct}% ${label}`;
      };

      // Helper to create a data row (unified component)
      const row = (abbrev, desc, value, unit, percent) => `
        <div class="data-row">
          <span class="data-row__id">${abbrev}</span>
          <span class="data-row__label">${desc}</span>
          <span class="data-row__value">${value}</span>
          <span class="data-row__unit">${unit}</span>
          <span class="data-row__meta">${percent}</span>
        </div>
      `;

      // Helper for narrow rows (right column, unified component)
      const rowNarrow = (abbrev, desc, value, unit = '') => `
        <div class="data-row data-row--narrow">
          <span class="data-row__id">${abbrev}</span>
          <span class="data-row__label">${desc}</span>
          <span class="data-row__value">${value}</span>
          <span class="data-row__unit">${unit}</span>
        </div>
      `;

      const gv = g.gebaeudevolumen || {};
      const gsf = g.grundstueckflaechen || {};
      const gfl = g.gebaeudeflaechen || {};
      const din = g.flaechenDin277 || {};
      const allg = g.allgemeineAngaben || {};
      const kw = g.kennzahlenWirtschaftlichkeit || {};
      const ap = g.arbeitsplatzkennzahlen || {};
      const fq = g.formquotienten || {};

      // Base values for percentage calculations
      const baseGV = gv.gv;
      const baseGSF = gsf.gsf;
      const baseGF = gfl.gf;

      content.innerHTML = `
        ${renderKostenBkpSection(project)}
        <h2 class="tab-header">Volumen und Flächen nach SIA 416</h2>
        <div class="tab-container tab-container--two-column">
          <!-- Left Column: Volumen und Flächen nach SIA 416 -->
          <div class="tab-container">
            <!-- Gebäudevolumen -->
            <div class="tab-section">
              <div class="tab-section-header">Gebäudevolumen</div>
              <div class="data-rows">
                ${row('GV', 'Gebäudevolumen', formatNumber(gv.gv), 'm³', calcPercent(gv.gv, baseGV, 'GV'))}
                ${row('GV OG', 'Gebäudevolumen Obergeschosse', formatNumber(gv.gvOg), 'm³', calcPercent(gv.gvOg, baseGV, 'GV'))}
                ${row('GV UG', 'Gebäudevolumen Untergeschosse', formatNumber(gv.gvUg), 'm³', calcPercent(gv.gvUg, baseGV, 'GV'))}
              </div>
            </div>

            <!-- Grundstücksflächen -->
            <div class="tab-section">
              <div class="tab-section-header">Grundstücksflächen</div>
              <div class="data-rows">
                ${row('GSF', 'Grundstücksfläche', formatNumber(gsf.gsf), 'm²', calcPercent(gsf.gsf, baseGSF, 'GSF'))}
                ${row('GGF', 'Gebäudegrundfläche', formatNumber(gsf.ggf), 'm²', calcPercent(gsf.ggf, baseGSF, 'GSF'))}
                ${row('UF', 'Umgebungsfläche', formatNumber(gsf.uf), 'm²', calcPercent(gsf.uf, baseGSF, 'GSF'))}
              </div>
            </div>

            <!-- Gebäudeflächen -->
            <div class="tab-section">
              <div class="tab-section-header">Gebäudeflächen</div>
              <div class="data-rows">
                ${row('GF', 'Geschossfläche', formatNumber(gfl.gf), 'm²', calcPercent(gfl.gf, baseGF, 'GF'))}
                ${row('GF OG', 'Geschossfläche Obergeschosse', formatNumber(gfl.gfOg), 'm²', calcPercent(gfl.gfOg, baseGF, 'GF'))}
                ${row('GF UG', 'Geschossfläche Untergeschosse', formatNumber(gfl.gfUg), 'm²', calcPercent(gfl.gfUg, baseGF, 'GF'))}
                ${row('KF', 'Konstruktionsfläche', formatNumber(gfl.kf), 'm²', calcPercent(gfl.kf, baseGF, 'GF'))}
                ${row('NGF', 'Nettogeschossfläche', formatNumber(gfl.ngf), 'm²', calcPercent(gfl.ngf, baseGF, 'GF'))}
                ${row('NF', 'Nutzfläche', formatNumber(gfl.nf), 'm²', calcPercent(gfl.nf, baseGF, 'GF'))}
                ${row('HNF', 'Hauptnutzfläche', formatNumber(gfl.hnf), 'm²', calcPercent(gfl.hnf, baseGF, 'GF'))}
                ${row('NNF', 'Nebennutzfläche', formatNumber(gfl.nnf), 'm²', calcPercent(gfl.nnf, baseGF, 'GF'))}
                ${row('VF', 'Verkehrsfläche', formatNumber(gfl.vf), 'm²', calcPercent(gfl.vf, baseGF, 'GF'))}
                ${row('FF', 'Funktionsfläche', formatNumber(gfl.ff), 'm²', calcPercent(gfl.ff, baseGF, 'GF'))}
              </div>
            </div>

            <!-- Flächen DIN 277 -->
            <div class="tab-section">
              <div class="tab-section-header">Flächen DIN 277</div>
              <div class="data-rows">
                ${row('HNF 1', 'Wohnen und Aufenthalt', formatNumber(din.hnf1), 'm²', calcPercent(din.hnf1, baseGF, 'GF'))}
                ${row('HNF 2', 'Büroarbeit', formatNumber(din.hnf2), 'm²', calcPercent(din.hnf2, baseGF, 'GF'))}
                ${row('HNF 3', 'Produktion', formatNumber(din.hnf3), 'm²', calcPercent(din.hnf3, baseGF, 'GF'))}
                ${row('HNF 4', 'Lagern, Verteilen, Verkaufen', formatNumber(din.hnf4), 'm²', calcPercent(din.hnf4, baseGF, 'GF'))}
                ${row('HNF 5', 'Bildung, Unterricht, Kultur', formatNumber(din.hnf5), 'm²', calcPercent(din.hnf5, baseGF, 'GF'))}
                ${row('HNF 6', 'Heilen, Pflegen', formatNumber(din.hnf6), 'm²', calcPercent(din.hnf6, baseGF, 'GF'))}
                ${row('NNF 7', 'Nebennutzfläche', formatNumber(din.nnf7), 'm²', calcPercent(din.nnf7, baseGF, 'GF'))}
                ${row('FF 8', 'Betriebstechnische Anlagen', formatNumber(din.ff8), 'm²', calcPercent(din.ff8, baseGF, 'GF'))}
                ${row('VF 9', 'Verkehrserschliessung und -sicherung', formatNumber(din.vf9), 'm²', calcPercent(din.vf9, baseGF, 'GF'))}
                ${row('BUF 10', 'Verschiedene Nutzungen', formatNumber(din.buf10), 'm²', calcPercent(din.buf10, baseGF, 'GF'))}
              </div>
            </div>
          </div>

          <!-- Right Column: Kennzahlen -->
          <div class="tab-container">
            <!-- Allgemeine Angaben -->
            <div class="tab-section">
              <div class="tab-section-header">Allgemeine Angaben</div>
              <div class="data-rows">
                ${rowNarrow('', 'Anzahl Gebäude Stockwerke', formatNumber(allg.geschosse), '')}
                ${rowNarrow('', 'Anzahl Gebäude Stockwerke UG', formatNumber(allg.geschosseUg), '')}
              </div>
            </div>

            <!-- Kennzahlen Wirtschaftlichkeit der Grundrisse -->
            <div class="tab-section">
              <div class="tab-section-header">Kennzahlen Wirtschaftlichkeit der Grundrisse</div>
              <div class="data-rows">
                ${rowNarrow('HNF / GF', 'Hauptnutzfläche / Geschossfläche', formatPercent(kw.hnfGf), '')}
                ${rowNarrow('VMF / GF', 'Vermietbare Fläche / Geschossfläche', formatPercent(kw.vmfGf), '')}
              </div>
            </div>

            <!-- Arbeitsplatzkennzahlen -->
            <div class="tab-section">
              <div class="tab-section-header">Arbeitsplatzkennzahlen</div>
              <div class="data-rows">
                ${rowNarrow('AP', 'Anzahl Arbeitsplätze', formatNumber(ap.ap), '')}
                ${rowNarrow('GF / AP', 'Geschossfläche / Arbeitsplätze', formatNumber(ap.gfAp, 1), '')}
                ${rowNarrow('HNF 2 / AP', 'Hauptnutzfläche 2 / Arbeitsplätze', formatNumber(ap.hnf2Ap, 1), '')}
                ${rowNarrow('BKP 1 - 8 / AP', 'Baukosten BKP 1 - 8 / Arbeitsplätze', formatNumber(ap.bkp18Ap), '')}
                ${rowNarrow('BKP 2 / AP', 'Baukosten BKP 2 / Arbeitsplätze', formatNumber(ap.bkp2Ap), '')}
                ${rowNarrow('BKP 9 / AP', 'Baukosten BKP 9 / Arbeitsplätze', formatNumber(ap.bkp9Ap), '')}
              </div>
            </div>

            <!-- Formquotienten nach eBKP-H -->
            <div class="tab-section">
              <div class="tab-section-header">Formquotienten nach eBKP-H</div>
              <div class="data-rows">
                ${rowNarrow('AWF / GF', 'Aussenwandfläche / Geschossfläche', formatNumber(fq.awfGf, 2), '')}
                ${rowNarrow('DAF / GF', 'Dachfläche / Geschossfläche', formatNumber(fq.dafGf, 2), '')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Render Risiken content (Risiken tab)
    function renderRisikenContent(project) {
      const content = document.getElementById('detailContent');
      const risiken = project.risiken || {};

      // Category labels for display
      const categoryLabels = {
        technisch: 'Technisch',
        terminlich: 'Terminlich',
        rechtlich: 'Rechtlich',
        sonstige: 'Sonstige'
      };

      // Helper to create status dots (1=green, 2=orange, 3=red) - using unified components
      const renderStatusDots = (status) => {
        const levels = [
          { class: 'status-dot--low', title: 'Geringes Risiko' },
          { class: 'status-dot--medium', title: 'Mittleres Risiko' },
          { class: 'status-dot--high', title: 'Hohes Risiko' }
        ];
        return levels.map((level, index) => {
          const isActive = status === (index + 1);
          return `<div class="status-dot${isActive ? ` ${level.class}` : ''}" title="${level.title}"></div>`;
        }).join('');
      };

      // Helper to create a risk row (unified component)
      const riskRow = (risk) => `
        <div class="data-row data-row--risk">
          <span class="data-row__id">${risk.id || ''}</span>
          <span class="data-row__label">${risk.name || ''}</span>
          <div class="status-dots">
            ${renderStatusDots(risk.status)}
          </div>
        </div>
      `;

      // Helper to create a section (unified component)
      const renderSection = (categoryKey, risks) => {
        if (!risks || risks.length === 0) return '';
        return `
          <div class="tab-section">
            <div class="tab-section-header">${categoryLabels[categoryKey] || categoryKey}</div>
            <div class="data-rows">
              ${risks.map(riskRow).join('')}
            </div>
          </div>
        `;
      };

      content.innerHTML = `
        <h2 class="tab-header">Risiken</h2>
        <div class="tab-container tab-container--constrained">
          ${renderSection('technisch', risiken.technisch)}
          ${renderSection('terminlich', risiken.terminlich)}
          ${renderSection('rechtlich', risiken.rechtlich)}
          ${renderSection('sonstige', risiken.sonstige)}
        </div>
      `;
    }

    // Render Projektziele content (Projektziele tab)
    function renderProjektzieleContent(project) {
      const content = document.getElementById('detailContent');
      const pz = project.projektziele || {};
      const meilensteine = pz.meilensteine || [];

      // Helper to create a milestone table row (unified components)
      const milestoneRow = (milestone, index) => {
        const isCompleted = milestone.status === 'completed';
        const statusClass = isCompleted ? 'table-status--completed' : 'table-status--pending';
        const statusLabel = isCompleted ? 'Erledigt' : 'Offen';
        const buttonClass = isCompleted ? 'table-action-btn--completed' : '';
        const buttonIcon = isCompleted ? 'check_circle' : 'radio_button_unchecked';

        return `
          <tr>
            <td>${milestone.name || '-'}</td>
            <td>${milestone.plannedDate || '-'}</td>
            <td>${milestone.actualDate || '-'}</td>
            <td>
              <span class="table-status ${statusClass}">${statusLabel}</span>
            </td>
            <td>
              <button class="table-action-btn ${buttonClass}" onclick="toggleMilestoneStatus('${project.id}', ${index})" title="${isCompleted ? 'Als offen markieren' : 'Als erledigt markieren'}">
                <span class="material-icons-outlined">${buttonIcon}</span>
              </button>
            </td>
          </tr>
        `;
      };

      const milestoneTable = meilensteine.length > 0
        ? `
          <table class="data-table">
            <thead>
              <tr>
                <th>Meilenstein</th>
                <th>Geplant</th>
                <th>Effektiv</th>
                <th>Status</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody>
              ${meilensteine.map((m, i) => milestoneRow(m, i)).join('')}
            </tbody>
          </table>
        `
        : '<div class="empty-state">Keine Meilensteine definiert</div>';

      content.innerHTML = `
        <h2 class="tab-header">Projektziele</h2>
        <div class="tab-container">
          <!-- Projektbeschrieb Section -->
          <div class="tab-section">
            <div class="tab-section-header">Projektbeschrieb</div>
            <div class="detail-fields">
              <div class="detail-field">
                <span class="detail-field-label">Ausgangslage</span>
                <span class="detail-field-value">${pz.ausgangslage || '-'}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">Projektziele</span>
                <span class="detail-field-value">${pz.ziele || '-'}</span>
              </div>
            </div>
          </div>

          <!-- Kosten (Geplant) Section -->
          <div class="tab-section">
            <div class="tab-section-header">Kosten (Geplant)</div>
            <div class="detail-fields">
              <div class="detail-field">
                <span class="detail-field-label">Geplante Gesamtkosten</span>
                <span class="detail-field-value">${formatCurrency(project.plannedTotalCost)}</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">BKP 2 / m³ GV</span>
                <span class="detail-field-value">-</span>
              </div>
              <div class="detail-field">
                <span class="detail-field-label">BKP 2 / m² GF</span>
                <span class="detail-field-value">-</span>
              </div>
            </div>
          </div>

          <!-- Meilensteine Section -->
          <div class="tab-section">
            <div class="tab-section-header">Meilensteine</div>
            ${milestoneTable}
          </div>
        </div>
      `;
    }

    // Toggle milestone status (for demo purposes - updates UI only)
    function toggleMilestoneStatus(projectId, milestoneIndex) {
      const project = properties.find(p => p.id === projectId);
      if (!project || !project.projektziele?.meilensteine) return;

      const milestone = project.projektziele.meilensteine[milestoneIndex];
      if (!milestone) return;

      // Toggle status
      if (milestone.status === 'completed') {
        milestone.status = 'pending';
        milestone.actualDate = null;
      } else {
        milestone.status = 'completed';
        // Set actual date to today
        const today = new Date();
        milestone.actualDate = today.toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '.');
      }

      // Re-render the tab
      renderProjektzieleContent(project);
    }

    // Handle tab switching in detail view
    function switchDetailTab(tabName) {
      // Track current tab
      currentDetailTab = tabName;

      // Update active tab button
      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Get current project
      const project = properties.find(p => p.id === currentDetailProjectId);
      if (!project) return;

      // Always update header title when switching tabs or projects
      const title = `${project.projectNumber || '-'} - ${project.city || ''} ${project.region || ''}, ${project.projectName || '-'}`;
      document.getElementById('detailHeaderTitle').textContent = title;

      // Render appropriate content
      if (tabName === 'kennzahlen') {
        renderKennzahlenContent(project);
      } else if (tabName === 'risiken') {
        renderRisikenContent(project);
      } else if (tabName === 'projektziele') {
        renderProjektzieleContent(project);
      } else if (tabName === 'uebersicht') {
        renderDetailContent(project);
        // Re-initialize detail map after rendering
        setTimeout(() => {
          initializeDetailMap(project);
        }, 100);
      }

      // Update URL with tab parameter
      updateUrlParams();
    }

    // Set up detail tab click handlers
    function setupDetailTabs() {
      document.querySelectorAll('.detail-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          if (e.target.disabled) return;
          switchDetailTab(e.target.dataset.tab);
        });
      });
    }

    // Unified click handler (event delegation for tags and sidebar items)
    function handleContentClick(event) {
      // First, check if clicked on a filter tag (status-tag)
      const tag = event.target.closest('.status-tag[data-filter]');
      if (tag) {
        event.stopPropagation();
        event.preventDefault();

        const filterType = tag.dataset.filter;
        const filterValue = tag.dataset.value;

        // Add the filter
        advancedFilters[filterType].add(filterValue);

        applyFilters();

        // Update filter modal if it's open
        if (document.getElementById('filterModalOverlay').classList.contains('active')) {
          renderFilterModal();
        }
        return;
      }

      // Check if clicked on a gallery card
      const card = event.target.closest('.card[data-id]');
      if (card) {
        openDetailView(card.dataset.id);
        return;
      }

      // Check if clicked on a list table row
      const tableRow = event.target.closest('.list-table tbody tr[data-id]');
      if (tableRow) {
        openDetailView(tableRow.dataset.id);
        return;
      }

      // Check if clicked on "Details anzeigen" button in map popup
      const popupLink = event.target.closest('.popup-link[data-id]');
      if (popupLink) {
        openDetailView(popupLink.dataset.id);
        return;
      }

      // Check if clicked on a map sidebar item
      const sidebarItem = event.target.closest('.map-sidebar-item[data-id]');
      if (sidebarItem) {
        flyToProperty(sidebarItem.dataset.id);
        return;
      }
    }

    // Set up unified event delegation
    document.addEventListener('click', handleContentClick);

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (event) => {
      const params = new URLSearchParams(window.location.search);
      const projectId = params.get('id');
      const view = params.get('view');

      // Handle detail view navigation
      if (projectId) {
        const project = properties.find(p => p.id === projectId);
        if (project) {
          openDetailView(projectId, true); // skipHistory = true
        }
        return;
      }

      // Close detail view if navigating away from it
      if (document.getElementById('detailView').classList.contains('active')) {
        closeDetailView(true); // skipHistory = true
      }

      if (view && ['gallery', 'list', 'map'].includes(view)) {
        setView(view);
      }
    });

    // --- INIT ---
    setupFilterModal();
    setupSearch();
    setupViewToggle();
    setupDetailTabs();
    loadFiltersFromUrl();
    setView(currentView);

    fetch('data.json')
      .then(res => res.json())
      .then(data => {
        // Store references for label lookups
        dataReferences = data.meta?.references || {};

        // Create a map of buildings by ID for quick lookup
        const buildingsMap = new Map();
        (data.buildings || []).forEach(b => buildingsMap.set(b.id, b));

        // Join projects with their buildings to get location data
        properties = (data.projects || []).map(project => {
          const building = buildingsMap.get(project.buildingId) || null;
          return {
            ...project,
            // Map projectStatus to status for filter compatibility
            status: project.projectStatus,
            // Inherit location data from building
            lat: building?.lat,
            lng: building?.lng,
            street: building?.street,
            streetNumber: building?.streetNumber,
            zip: building?.zip,
            city: building?.city,
            region: building?.region,
            country: building?.country,
            // Keep reference to building designation for backwards compatibility
            buildingDesignation: building?.designation,
            // Store full building object for Gebäude section
            building: building
          };
        });

        filteredProperties = [...properties];
        extractFilterOptions();
        applyFilters();

        // Check if URL has project ID and open detail view
        const params = getUrlParams();
        if (params.id) {
          const project = properties.find(p => p.id === params.id);
          if (project) {
            openDetailView(params.id, true); // skipHistory = true for initial load
          }
        }
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('objectGrid').innerHTML = `<div style="grid-column: 1/-1; padding: 20px; text-align: center; background: white;">Fehler beim Laden. Starte via Live Server.</div>`;
      });
  </script>
</body>
</html>
